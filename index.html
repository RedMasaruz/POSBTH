<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus POS 2026 | ศูนย์บัญชาการขาย Omnichannel</title>

    <!-- Bootstrap 5 + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Google Fonts (Inter + Noto Sans Thai) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ===== ROOT VARIABLES ===== */
        :root {
            /* Color Palette 2026 */
            --color-bg: #0f172a;
            --color-surface: #1e293b;
            --color-surface-light: #334155;
            --color-primary: #3b82f6;
            --color-primary-dark: #2563eb;
            --color-accent: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-success: #10b981;
            --color-text: #f8fafc;
            --color-text-muted: #94a3b8;
            --color-border: #475569;
            
            /* Typography */
            --font-main: 'Inter', sans-serif;
            --font-thai: 'Noto Sans Thai', sans-serif;
            
            /* Spacing */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
        }

        /* ===== BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main), var(--font-thai), sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 80px 1fr;
            min-height: 100vh;
            gap: 1px;
            background: var(--color-border);
        }

        /* Header */
        .app-header {
            grid-column: 1 / -1;
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--color-text);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Sidebar */
        .app-sidebar {
            background: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 24px;
            color: var(--color-text-muted);
            text-decoration: none;
            transition: all var(--transition-fast);
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .nav-item:hover {
            background: var(--color-surface-light);
            color: var(--color-text);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
            color: var(--color-primary);
            border-left-color: var(--color-primary);
        }

        .nav-item .icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--color-primary);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Main Content */
        .app-main {
            background: var(--color-bg);
            padding: 24px;
            overflow-y: auto;
        }

        /* ===== COMPONENTS ===== */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .card-body {
            padding: 24px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-md);
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-outline:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .btn-lg {
            padding: 16px 28px;
            font-size: 1.1rem;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--color-success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--color-warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--color-danger); }
        .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--color-primary); }

        /* ===== POS LAYOUT ===== */
        .pos-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            height: calc(100vh - 180px);
        }

        /* Products Grid */
        .products-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            overflow-y: auto;
            padding-right: 8px;
            flex: 1;
        }

        .product-card {
            background: var(--color-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border);
            padding: 20px;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .product-card:active {
            transform: translateY(-2px);
        }

        .product-image {
            width: 100%;
            height: 120px;
            background: var(--color-surface-light);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-name {
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--color-text);
        }

        .product-price {
            font-weight: 700;
            font-size: 1.25rem;
            color: var(--color-primary);
            margin-bottom: 8px;
        }

        .product-stock {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .product-stock.low {
            color: var(--color-warning);
            font-weight: 600;
        }

        .product-stock.out {
            color: var(--color-danger);
            font-weight: 600;
        }

        /* Cart Section */
        .cart-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 20px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 16px;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--color-surface-light);
            padding: 4px 12px;
            border-radius: var(--radius-md);
        }

        .qty-btn {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            padding: 4px;
            font-size: 1.2rem;
            line-height: 1;
        }

        .qty-value {
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .cart-item-name {
            font-weight: 500;
        }

        .cart-item-price {
            font-weight: 700;
            color: var(--color-primary);
        }

        .cart-item-remove {
            color: var(--color-danger);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 1.2rem;
        }

        /* Cart Summary */
        .cart-summary {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: 24px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-size: 1rem;
        }

        .summary-row.total {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary);
            border-top: 2px solid var(--color-border);
            padding-top: 16px;
            margin-top: 16px;
        }

        .payment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 24px;
        }

        /* ===== TYPOGRAPHY UTILITIES ===== */
        .text-display {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1.2;
        }

        .text-title {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.3;
        }

        .text-subtitle {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--color-text-muted);
        }

        .text-body {
            font-size: 1rem;
            line-height: 1.6;
        }

        .text-small {
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease forwards;
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease forwards;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1200px) {
            .pos-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .products-grid {
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
            }
            
            .app-sidebar {
                display: none;
            }
            
            .header-actions {
                display: none;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }

        /* ===== UTILITIES ===== */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .p-0 { padding: 0; }
        .p-4 { padding: 16px; }
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--color-text-muted); }
        .text-success { color: var(--color-success); }
        .text-warning { color: var(--color-warning); }
        .text-danger { color: var(--color-danger); }

        /* ===== LOADING SKELETON ===== */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-surface-light) 25%,
                var(--color-surface) 50%,
                var(--color-surface-light) 75%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-md);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--color-surface);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-surface-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary);
        }

        /* ===== OFFLINE INDICATOR ===== */
        .offline-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-danger);
            color: white;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-weight: 600;
            z-index: 1000;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .offline-indicator.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        /* ===== TOAST NOTIFICATION ===== */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s ease;
            border-left: 4px solid var(--color-primary);
        }

        .toast-success {
            border-left-color: var(--color-success);
        }

        .toast-error {
            border-left-color: var(--color-danger);
        }

        .toast-warning {
            border-left-color: var(--color-warning);
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--color-surface-light);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== FORM CONTROLS ===== */
        .form-control, .form-select {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .input-group {
            display: flex;
        }

        .input-group-text {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-right: none;
            padding: 8px 12px;
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
            color: var(--color-text-muted);
        }

        .input-group .form-control {
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        /* ===== CATEGORY FILTER ===== */
        .category-dropdown {
            position: relative;
            display: inline-block;
        }

        .category-menu {
            display: none;
            position: absolute;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            min-width: 200px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            margin-top: 5px;
        }

        .category-menu.show {
            display: block;
        }

        .category-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .category-item:hover {
            background: var(--color-surface-light);
        }

        .category-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--color-primary);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Offline Indicator -->
    <div class="offline-indicator" id="offlineIndicator">
        <i class="bi bi-wifi-off"></i> ทำงานในโหมดออฟไลน์
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <span>Nexus POS 2026</span>
            </div>
            
            <div class="header-actions">
                <div class="text-small text-muted" id="currentTime">--:--:--</div>
                <div class="badge badge-success" id="syncStatus">
                    <i class="bi bi-cloud-check"></i> ออนไลน์
                </div>
                <button class="btn btn-outline" id="settingsBtn">
                    <i class="bi bi-gear"></i> ตั้งค่า
                </button>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="app-sidebar">
            <a href="#" class="nav-item active" data-view="pos">
                <i class="bi bi-cart-fill icon"></i>
                <span>ขายหน้าร้าน</span>
                <span class="nav-badge" id="cartCount">0</span>
            </a>
            <a href="#" class="nav-item" data-view="orders">
                <i class="bi bi-receipt icon"></i>
                <span>ออเดอร์ทั้งหมด</span>
            </a>
            <a href="#" class="nav-item" data-view="products">
                <i class="bi bi-box-seam icon"></i>
                <span>จัดการสินค้า</span>
            </a>
            <a href="#" class="nav-item" data-view="inventory">
                <i class="bi bi-clipboard-data icon"></i>
                <span>สต็อคสินค้า</span>
            </a>
            <a href="#" class="nav-item" data-view="reports">
                <i class="bi bi-bar-chart icon"></i>
                <span>รายงาน</span>
            </a>
            <a href="#" class="nav-item" data-view="channels">
                <i class="bi bi-share icon"></i>
                <span>ช่องทางขาย</span>
                <span class="nav-badge" id="onlineOrdersCount">0</span>
            </a>
            <a href="#" class="nav-item" data-view="customers">
                <i class="bi bi-people icon"></i>
                <span>ลูกค้า</span>
            </a>
            
            <div style="flex: 1;"></div>
            
            <a href="#" class="nav-item text-danger" id="logoutBtn">
                <i class="bi bi-box-arrow-right icon"></i>
                <span>ออกจากระบบ</span>
            </a>
        </nav>

        <!-- Main Content -->
        <main class="app-main">
            <!-- POS View (Default) -->
            <div id="posView" class="view-container">
                <div class="pos-grid">
                    <!-- Products Section -->
                    <div class="products-section">
                        <div class="d-flex justify-between align-center mb-4">
                            <div>
                                <h2 class="text-title">สินค้า</h2>
                                <p class="text-muted" id="productCount">กำลังโหลด...</p>
                            </div>
                            <div class="d-flex gap-2">
                                <input type="text" 
                                       class="form-control" 
                                       placeholder="ค้นหาสินค้า..." 
                                       id="productSearch"
                                       style="min-width: 200px;">
                                <div class="category-dropdown">
                                    <button class="btn btn-outline" id="categoryFilterBtn">
                                        <i class="bi bi-filter"></i> หมวดหมู่
                                    </button>
                                    <div class="category-menu" id="categoryMenu">
                                        <!-- Categories will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="products-grid" id="productsGrid">
                            <!-- Products will be loaded here -->
                            <div class="skeleton" style="height: 200px;"></div>
                            <div class="skeleton" style="height: 200px;"></div>
                            <div class="skeleton" style="height: 200px;"></div>
                        </div>
                    </div>

                    <!-- Cart Section -->
                    <div class="cart-section">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">ตะกร้าสินค้า</h3>
                                <button class="btn btn-sm btn-outline" id="clearCartBtn">
                                    <i class="bi bi-trash"></i> ล้างทั้งหมด
                                </button>
                            </div>
                            <div class="cart-items" id="cartItems">
                                <!-- Cart items will be loaded here -->
                                <div class="text-center p-4 text-muted">
                                    <i class="bi bi-cart" style="font-size: 3rem;"></i>
                                    <p class="mt-2">ไม่มีสินค้าในตะกร้า</p>
                                </div>
                            </div>
                        </div>

                        <!-- Cart Summary -->
                        <div class="cart-summary card">
                            <div class="summary-row">
                                <span>จำนวนสินค้า</span>
                                <span id="totalItems">0 ชิ้น</span>
                            </div>
                            <div class="summary-row">
                                <span>รวม</span>
                                <span id="subtotal">0.00 ฿</span>
                            </div>
                            <div class="summary-row">
                                <span>ภาษี (<span id="taxRate">7</span>%)</span>
                                <span id="tax">0.00 ฿</span>
                            </div>
                            <div class="summary-row total">
                                <span>รวมสุทธิ</span>
                                <span id="totalAmount">0.00 ฿</span>
                            </div>

                            <div class="payment-buttons">
                                <button class="btn btn-success btn-lg" id="cashPaymentBtn">
                                    <i class="bi bi-cash"></i> เงินสด
                                </button>
                                <button class="btn btn-primary btn-lg" id="cardPaymentBtn">
                                    <i class="bi bi-credit-card"></i> บัตร
                                </button>
                                <button class="btn btn-outline" id="splitPaymentBtn">
                                    <i class="bi bi-arrow-left-right"></i> แบ่งจ่าย
                                </button>
                                <button class="btn btn-danger" id="cancelOrderBtn">
                                    ยกเลิก
                                </button>
                            </div>

                            <div class="mt-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-tag"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control" 
                                           placeholder="หมายเหตุออเดอร์ (ถ้ามี)"
                                           id="orderNotes">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders View -->
            <div id="ordersView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ออเดอร์ทั้งหมด</h3>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="orderStatusFilter" style="width: 150px;">
                                <option value="all">สถานะทั้งหมด</option>
                                <option value="pending">รอดำเนินการ</option>
                                <option value="paid">ชำระเงินแล้ว</option>
                                <option value="completed">สำเร็จ</option>
                                <option value="cancelled">ยกเลิก</option>
                            </select>
                            <button class="btn btn-outline" id="syncOrdersBtn">
                                <i class="bi bi-arrow-repeat"></i> ซิงค์
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" style="color: var(--color-text);">
                                <thead>
                                    <tr>
                                        <th>รหัสออเดอร์</th>
                                        <th>วันที่</th>
                                        <th>ช่องทาง</th>
                                        <th>จำนวน</th>
                                        <th>ยอดรวม</th>
                                        <th>สถานะ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTable">
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other views will be implemented similarly -->
            <div id="productsView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">จัดการสินค้า</h3>
                        <button class="btn btn-primary" id="addProductBtn">
                            <i class="bi bi-plus"></i> เพิ่มสินค้า
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table" style="color: var(--color-text);">
                                <thead>
                                    <tr>
                                        <th>ชื่อสินค้า</th>
                                        <th>SKU</th>
                                        <th>ราคา</th>
                                        <th>สต็อก</th>
                                        <th>หมวดหมู่</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTable">
                                    <!-- Products will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="inventoryView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">สต็อคสินค้า</h3>
                        <button class="btn btn-primary" id="adjustInventoryBtn">
                            <i class="bi bi-plus-slash-minus"></i> ปรับสต็อก
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="inventoryContent">
                            <!-- Inventory content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="reportsView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">รายงาน</h3>
                        <div class="d-flex gap-2">
                            <input type="date" class="form-control" id="reportStartDate">
                            <input type="date" class="form-control" id="reportEndDate" value="<?php echo date('Y-m-d'); ?>">
                            <button class="btn btn-primary" id="generateReportBtn">
                                <i class="bi bi-file-earmark-bar-graph"></i> สร้างรายงาน
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="reportContent">
                            <!-- Report content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="channelsView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ช่องทางขาย</h3>
                        <button class="btn btn-primary" id="syncChannelsBtn">
                            <i class="bi bi-arrow-repeat"></i> ซิงค์ช่องทาง
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row" id="channelsContent">
                            <!-- Channels content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="customersView" class="view-container d-none">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">ลูกค้า</h3>
                        <button class="btn btn-primary" id="addCustomerBtn">
                            <i class="bi bi-person-plus"></i> เพิ่มลูกค้า
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="customersContent">
                            <!-- Customers content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ===== GLOBAL CONFIGURATION =====
        const CONFIG = {
            APP_NAME: 'Nexus POS 2026',
            VERSION: '1.0.1',
            
            // Google Apps Script URL
            GAS_URL: 'https://script.google.com/macros/s/AKfycbxNfDczM7xf0swVNIsBrrVfayUrt_z1Kehidz2ZnnaJINSZJ-kl0VLme7BKUcZ30HTF/exec',
            
            // IndexedDB configuration
            DB_NAME: 'nexus_pos_db_v2',
            DB_VERSION: 3,
            
            // Store names
            STORES: {
                PRODUCTS: 'products',
                ORDERS: 'orders',
                CART: 'cart',
                SYNC_QUEUE: 'sync_queue',
                SETTINGS: 'settings'
            },
            
            // Order states
            ORDER_STATES: {
                PENDING: 'pending',
                PAID: 'paid',
                COMPLETED: 'completed',
                CANCELLED: 'cancelled'
            },
            
            // Channels
            CHANNELS: {
                STORE: 'store',
                SHOPEE: 'shopee',
                LAZADA: 'lazada',
                LINE: 'line',
                FACEBOOK: 'facebook'
            },
            
            // Sync settings
            SYNC_CONFIG: {
                MAX_RETRIES: 3,
                RETRY_DELAY: 1000,
                BATCH_SIZE: 10,
                EXPONENTIAL_BACKOFF: true
            }
        };

        // ===== STATE MANAGEMENT =====
        let state = {
            products: [],
            cart: {
                items: [],
                subtotal: 0,
                tax: 0,
                total: 0,
                notes: ''
            },
            orders: [],
            currentView: 'pos',
            isOnline: navigator.onLine,
            syncQueue: [],
            settings: {
                taxRate: 7,
                autoPrint: true,
                soundEnabled: true,
                syncInterval: 30000
            },
            initialized: false,
            categories: []
        };

        // ===== INDEXEDDB SETUP =====
        let db = null;
        let dbInitialized = false;

        async function initDB() {
            if (dbInitialized && db) return db;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(CONFIG.DB_NAME, CONFIG.DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(new Error(`Database error: ${event.target.error.message}`));
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    dbInitialized = true;
                    
                    // Add comprehensive error handler
                    db.onerror = (event) => {
                        console.error('Database error:', event.target.error);
                        showToast('เกิดข้อผิดพลาดในฐานข้อมูล', 'error');
                    };
                    
                    db.onversionchange = () => {
                        db.close();
                        console.log('Database version changed');
                    };
                    
                    console.log('IndexedDB initialized successfully');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('Upgrading database...');
                    const db = event.target.result;
                    
                    // Products store
                    if (!db.objectStoreNames.contains(CONFIG.STORES.PRODUCTS)) {
                        const store = db.createObjectStore(CONFIG.STORES.PRODUCTS, { 
                            keyPath: 'id',
                            autoIncrement: false 
                        });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('sku', 'sku', { unique: true });
                        store.createIndex('updated_at', 'updated_at', { unique: false });
                    }
                    
                    // Orders store
                    if (!db.objectStoreNames.contains(CONFIG.STORES.ORDERS)) {
                        const store = db.createObjectStore(CONFIG.STORES.ORDERS, { 
                            keyPath: 'id',
                            autoIncrement: false 
                        });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('channel', 'channel', { unique: false });
                        store.createIndex('created_at', 'created_at', { unique: false });
                        store.createIndex('synced', 'synced', { unique: false });
                    }
                    
                    // Cart store (separate from orders)
                    if (!db.objectStoreNames.contains(CONFIG.STORES.CART)) {
                        const store = db.createObjectStore(CONFIG.STORES.CART, { 
                            keyPath: 'id',
                            autoIncrement: false 
                        });
                    }
                    
                    // Sync queue store
                    if (!db.objectStoreNames.contains(CONFIG.STORES.SYNC_QUEUE)) {
                        const store = db.createObjectStore(CONFIG.STORES.SYNC_QUEUE, { 
                            keyPath: 'id',
                            autoIncrement: true 
                        });
                        store.createIndex('type', 'type', { unique: false });
                        store.createIndex('status', 'status', { unique: false });
                        store.createIndex('created_at', 'created_at', { unique: false });
                    }
                    
                    // Settings store
                    if (!db.objectStoreNames.contains(CONFIG.STORES.SETTINGS)) {
                        const store = db.createObjectStore(CONFIG.STORES.SETTINGS, { 
                            keyPath: 'key',
                            autoIncrement: false 
                        });
                    }
                    
                    event.target.transaction.oncomplete = () => {
                        console.log('Database upgrade completed');
                    };
                };
            });
        }

        // ===== DATA ACCESS FUNCTIONS =====
        async function ensureDB() {
            if (!dbInitialized) {
                await initDB();
            }
            return db;
        }

        async function getDBTransaction(storeNames, mode = 'readonly') {
            await ensureDB();
            
            return new Promise((resolve, reject) => {
                try {
                    const transaction = db.transaction(storeNames, mode);
                    
                    transaction.onerror = (event) => {
                        console.error('Transaction error:', event.target.error);
                        reject(event.target.error);
                    };
                    
                    transaction.oncomplete = () => {
                        // Transaction completed successfully
                    };
                    
                    resolve(transaction);
                } catch (error) {
                    console.error('Error creating transaction:', error);
                    reject(error);
                }
            });
        }

        async function saveToDB(storeName, data) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = await getDBTransaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    if (Array.isArray(data)) {
                        // Batch operation
                        const promises = data.map(item => {
                            return new Promise((itemResolve, itemReject) => {
                                const request = store.put(item);
                                request.onsuccess = () => itemResolve();
                                request.onerror = (event) => itemReject(event.target.error);
                            });
                        });
                        
                        await Promise.all(promises);
                    } else {
                        const request = store.put(data);
                        request.onsuccess = () => resolve();
                        request.onerror = (event) => reject(event.target.error);
                    }
                    
                    transaction.oncomplete = () => resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function getFromDB(storeName, key = null) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = await getDBTransaction([storeName], 'readonly');
                    const store = transaction.objectStore(storeName);
                    
                    if (key === null) {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = (event) => reject(event.target.error);
                    } else {
                        const request = store.get(key);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = (event) => reject(event.target.error);
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function deleteFromDB(storeName, key) {
            return new Promise(async (resolve, reject) => {
                try {
                    const transaction = await getDBTransaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    const request = store.delete(key);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                    
                    transaction.oncomplete = () => resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ===== SETTINGS MANAGEMENT =====
        async function loadSettings() {
            try {
                const savedSettings = await getFromDB(CONFIG.STORES.SETTINGS, 'app_settings');
                
                if (savedSettings) {
                    state.settings = {
                        ...state.settings,
                        ...savedSettings
                    };
                }
                
                // Apply settings to UI
                document.getElementById('taxRate').textContent = state.settings.taxRate;
                
                return state.settings;
            } catch (error) {
                console.error('Error loading settings:', error);
                return state.settings;
            }
        }

        async function saveSettings(newSettings) {
            try {
                state.settings = { ...state.settings, ...newSettings };
                
                await saveToDB(CONFIG.STORES.SETTINGS, {
                    key: 'app_settings',
                    ...state.settings
                });
                
                // Update UI
                document.getElementById('taxRate').textContent = state.settings.taxRate;
                
                return true;
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('ไม่สามารถบันทึกการตั้งค่าได้', 'error');
                return false;
            }
        }

        // ===== PRODUCTS MANAGEMENT =====
        async function loadProducts() {
            try {
                showLoading();
                
                // Load from IndexedDB first
                const cachedProducts = await getFromDB(CONFIG.STORES.PRODUCTS);
                
                if (cachedProducts && cachedProducts.length > 0) {
                    state.products = cachedProducts;
                    extractCategories();
                    renderProductsGrid();
                }
                
                // Try to sync with server if online
                if (state.isOnline) {
                    await fetchProductsFromServer();
                } else if (cachedProducts.length === 0) {
                    // If offline and no cached products, show error
                    document.getElementById('productsGrid').innerHTML = `
                        <div class="text-center" style="grid-column: 1 / -1; padding: 40px;">
                            <i class="bi bi-wifi-off" style="font-size: 3rem; color: var(--color-text-muted);"></i>
                            <p class="mt-2 text-muted">ไม่สามารถโหลดสินค้าได้ขณะออฟไลน์</p>
                        </div>
                    `;
                }
                
                hideLoading();
                return state.products;
            } catch (error) {
                console.error('Error loading products:', error);
                hideLoading();
                showToast('ไม่สามารถโหลดสินค้าได้', 'error');
                return [];
            }
        }

        async function fetchProductsFromServer() {
            if (!state.isOnline) {
                throw new Error('Offline mode - cannot fetch from server');
            }
            
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    },
                    body: JSON.stringify({ 
                        action: 'getProducts',
                        timestamp: Date.now() // Prevent caching
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    // Process products with validation
                    const productsWithTimestamp = result.data.map(product => ({
                        ...product,
                        id: String(product.id || Date.now() + Math.random()),
                        name: product.name || 'Unknown',
                        price: parseFloat(product.price) || 0,
                        stock: parseInt(product.stock) || 0,
                        min_stock: parseInt(product.min_stock) || 5,
                        category: product.category || 'uncategorized',
                        sku: product.sku || '',
                        image: product.image || '',
                        unit: product.unit || 'ชิ้น',
                        updated_at: new Date().toISOString()
                    })).filter(product => product.price > 0); // Filter out invalid products
                    
                    // Save to IndexedDB
                    await saveToDB(CONFIG.STORES.PRODUCTS, productsWithTimestamp);
                    
                    // Update state
                    state.products = productsWithTimestamp;
                    extractCategories();
                    renderProductsGrid();
                    
                    showToast(`โหลดสินค้า ${productsWithTimestamp.length} รายการเรียบร้อย`, 'success');
                    
                    return productsWithTimestamp;
                } else {
                    throw new Error(result.message || 'Failed to fetch products from server');
                }
            } catch (error) {
                console.error('Error fetching products:', error);
                
                // If we have cached products, show them
                if (state.products.length > 0) {
                    showToast('แสดงสินค้าจากแคช เนื่องจากเซิร์ฟเวอร์มีปัญหา', 'warning');
                } else {
                    throw error;
                }
            }
        }

        function extractCategories() {
            const categoriesSet = new Set();
            state.products.forEach(product => {
                if (product.category && product.category.trim()) {
                    categoriesSet.add(product.category.trim());
                }
            });
            state.categories = ['ทั้งหมด', ...Array.from(categoriesSet).sort()];
            renderCategoryFilter();
        }

        // ===== CART MANAGEMENT =====
        function addToCart(product) {
            if (!product || !product.id) {
                showToast('ข้อมูลสินค้าไม่ถูกต้อง', 'error');
                return;
            }
            
            if (state.products.length === 0) {
                showToast('ยังไม่โหลดสินค้า กรุณารอสักครู่', 'warning');
                return;
            }
            
            // Get current product info from state
            const currentProduct = state.products.find(p => p.id === product.id);
            if (!currentProduct) {
                showToast('ไม่พบสินค้านี้ในระบบ', 'error');
                return;
            }
            
            // Check stock
            const availableStock = parseInt(currentProduct.stock) || 0;
            if (availableStock <= 0) {
                showToast('สินค้าหมดสต็อก', 'warning');
                return;
            }
            
            // Check if already in cart
            const existingItem = state.cart.items.find(item => item.id === product.id);
            
            if (existingItem) {
                // Check stock limit
                if (existingItem.quantity >= availableStock) {
                    showToast('ไม่สามารถเพิ่มได้ เนื่องจากสต็อกไม่เพียงพอ', 'warning');
                    return;
                }
                existingItem.quantity += 1;
            } else {
                state.cart.items.push({
                    id: product.id,
                    name: currentProduct.name || 'Unknown',
                    price: parseFloat(currentProduct.price) || 0,
                    quantity: 1,
                    image: currentProduct.image,
                    sku: currentProduct.sku,
                    maxStock: availableStock
                });
            }
            
            // Update cart
            updateCart();
            
            // Visual feedback
            const productCard = document.querySelector(`[data-product-id="${product.id}"]`);
            if (productCard) {
                productCard.classList.add('animate-pulse');
                setTimeout(() => {
                    productCard.classList.remove('animate-pulse');
                }, 500);
            }
            
            showToast(`เพิ่ม "${currentProduct.name}" ลงตะกร้าแล้ว`, 'success');
            
            // Play sound if enabled
            if (state.settings.soundEnabled) {
                playSound('add');
            }
        }

        function removeFromCart(productId) {
            state.cart.items = state.cart.items.filter(item => item.id !== productId);
            updateCart();
            showToast('ลบสินค้าจากตะกร้าแล้ว', 'success');
        }

        function updateCartQuantity(productId, delta) {
            const item = state.cart.items.find(item => item.id === productId);
            if (!item) return;
            
            const newQuantity = item.quantity + delta;
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }
            
            // Check stock limit
            if (item.maxStock && newQuantity > item.maxStock) {
                showToast('ไม่สามารถเพิ่มได้ เนื่องจากสต็อกไม่เพียงพอ', 'warning');
                return;
            }
            
            item.quantity = newQuantity;
            updateCart();
        }

        function updateCart() {
            // Calculate totals
            let subtotal = 0;
            let totalItems = 0;
            
            state.cart.items.forEach(item => {
                const itemTotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0);
                subtotal += itemTotal;
                totalItems += parseInt(item.quantity) || 0;
            });
            
            const taxRate = parseFloat(state.settings.taxRate) || 7;
            const tax = subtotal * (taxRate / 100);
            const total = subtotal + tax;
            
            // Update state
            state.cart.subtotal = parseFloat(subtotal.toFixed(2));
            state.cart.tax = parseFloat(tax.toFixed(2));
            state.cart.total = parseFloat(total.toFixed(2));
            
            // Update UI
            renderCart();
            updateCartCount();
            
            // Save to IndexedDB
            saveCartToDB();
        }

        async function saveCartToDB() {
            try {
                await saveToDB(CONFIG.STORES.CART, {
                    id: 'current_cart',
                    ...state.cart,
                    updated_at: new Date().toISOString()
                });
            } catch (error) {
                console.error('Error saving cart:', error);
            }
        }

        async function loadCartFromDB() {
            try {
                const savedCart = await getFromDB(CONFIG.STORES.CART, 'current_cart');
                if (savedCart && savedCart.items) {
                    // Validate cart items against current products
                    const validItems = savedCart.items.filter(item => {
                        const product = state.products.find(p => p.id === item.id);
                        if (!product) return false;
                        
                        // Update max stock from current product info
                        item.maxStock = parseInt(product.stock) || 0;
                        return item.maxStock > 0;
                    });
                    
                    state.cart = {
                        ...savedCart,
                        items: validItems
                    };
                    updateCart();
                }
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        function clearCart() {
            if (state.cart.items.length === 0) return;
            
            Swal.fire({
                title: 'ยืนยันการล้างตะกร้า',
                text: 'ต้องการล้างตะกร้าทั้งหมดใช่หรือไม่?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ล้าง',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--color-danger)',
                cancelButtonColor: 'var(--color-primary)',
                background: 'var(--color-surface)',
                color: 'var(--color-text)',
                customClass: {
                    popup: 'swal-popup'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    state.cart = {
                        items: [],
                        subtotal: 0,
                        tax: 0,
                        total: 0,
                        notes: ''
                    };
                    updateCart();
                    showToast('ล้างตะกร้าเรียบร้อยแล้ว', 'success');
                }
            });
        }

        // ===== ORDER MANAGEMENT =====
        async function createOrder(paymentMethod) {
            if (state.cart.items.length === 0) {
                showToast('ไม่มีสินค้าในตะกร้า', 'warning');
                return null;
            }
            
            // Validate stock before creating order
            const stockIssues = [];
            
            for (const item of state.cart.items) {
                const product = state.products.find(p => p.id === item.id);
                if (!product) {
                    stockIssues.push(`ไม่พบสินค้า "${item.name}" ในระบบ`);
                } else if ((parseInt(product.stock) || 0) < (parseInt(item.quantity) || 0)) {
                    stockIssues.push(`สินค้า "${item.name}" สต็อกไม่เพียงพอ (เหลือ ${product.stock} ชิ้น)`);
                }
            }
            
            if (stockIssues.length > 0) {
                showToast(stockIssues[0], 'error');
                return null;
            }
            
            // Generate order ID
            const orderId = 'ORD-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4).toUpperCase();
            const now = new Date().toISOString();
            
            // Create order object
            const order = {
                id: orderId,
                channel: CONFIG.CHANNELS.STORE,
                items: state.cart.items.map(item => ({
                    productId: item.id,
                    name: item.name,
                    price: parseFloat(item.price) || 0,
                    quantity: parseInt(item.quantity) || 0,
                    sku: item.sku,
                    total: parseFloat(item.price * item.quantity).toFixed(2)
                })),
                subtotal: parseFloat(state.cart.subtotal.toFixed(2)),
                tax: parseFloat(state.cart.tax.toFixed(2)),
                total: parseFloat(state.cart.total.toFixed(2)),
                payment_method: paymentMethod,
                status: CONFIG.ORDER_STATES.PAID,
                notes: state.cart.notes || '',
                created_at: now,
                updated_at: now,
                synced: false,
                sync_attempts: 0,
                local: true
            };
            
            try {
                // Save order to IndexedDB
                await saveToDB(CONFIG.STORES.ORDERS, order);
                
                // Add to sync queue
                await addToSyncQueue({
                    type: 'order',
                    action: 'create',
                    data: order,
                    created_at: now,
                    status: 'pending',
                    retry_count: 0
                });
                
                // Update local state
                state.orders.unshift(order);
                
                // Update product stock in local state
                for (const item of state.cart.items) {
                    const productIndex = state.products.findIndex(p => p.id === item.id);
                    if (productIndex !== -1) {
                        state.products[productIndex].stock = Math.max(
                            0, 
                            (parseInt(state.products[productIndex].stock) || 0) - (parseInt(item.quantity) || 0)
                        );
                        state.products[productIndex].updated_at = now;
                    }
                }
                
                // Save updated products
                await saveToDB(CONFIG.STORES.PRODUCTS, state.products);
                
                // Clear cart
                state.cart = {
                    items: [],
                    subtotal: 0,
                    tax: 0,
                    total: 0,
                    notes: ''
                };
                updateCart();
                
                // Clear order notes
                const orderNotes = document.getElementById('orderNotes');
                if (orderNotes) orderNotes.value = '';
                
                // Show success message
                showOrderSuccess(order);
                
                // Try to sync immediately
                if (state.isOnline) {
                    setTimeout(() => syncOrders(), 1000);
                }
                
                // Print receipt (if enabled)
                if (state.settings.autoPrint) {
                    setTimeout(() => printReceipt(order), 500);
                }
                
                return order;
            } catch (error) {
                console.error('Error creating order:', error);
                showToast('เกิดข้อผิดพลาดในการสร้างออเดอร์', 'error');
                return null;
            }
        }

        // ===== SYNC MANAGEMENT =====
        async function addToSyncQueue(item) {
            try {
                await saveToDB(CONFIG.STORES.SYNC_QUEUE, {
                    ...item,
                    created_at: new Date().toISOString(),
                    status: 'pending'
                });
                
                // Update sync status badge
                updateSyncQueueBadge();
                
                return true;
            } catch (error) {
                console.error('Error adding to sync queue:', error);
                return false;
            }
        }

        async function getSyncQueue() {
            try {
                const queue = await getFromDB(CONFIG.STORES.SYNC_QUEUE);
                return queue || [];
            } catch (error) {
                console.error('Error getting sync queue:', error);
                return [];
            }
        }

        async function syncOrders() {
            if (!state.isOnline) {
                console.log('Offline mode - skipping sync');
                return;
            }
            
            try {
                showLoading();
                
                const queue = await getSyncQueue();
                const pendingItems = queue.filter(item => item.status === 'pending');
                
                if (pendingItems.length === 0) {
                    hideLoading();
                    updateSyncStatus();
                    return;
                }
                
                console.log(`Syncing ${pendingItems.length} items...`);
                showToast(`กำลังซิงค์ ${pendingItems.length} รายการ...`, 'info');
                
                // Process with concurrency control
                const results = {
                    success: 0,
                    failed: 0,
                    errors: []
                };
                
                for (let i = 0; i < pendingItems.length; i += CONFIG.SYNC_CONFIG.BATCH_SIZE) {
                    const batch = pendingItems.slice(i, i + CONFIG.SYNC_CONFIG.BATCH_SIZE);
                    
                    const batchPromises = batch.map(async (item) => {
                        try {
                            const result = await processSyncItem(item);
                            
                            if (result.success) {
                                results.success++;
                                
                                // Mark as synced in IndexedDB
                                await updateSyncItemStatus(item.id, 'completed');
                                
                                // Update order sync status
                                if (item.type === 'order' && item.data) {
                                    await updateOrderSyncStatus(item.data.id, true);
                                }
                            } else {
                                results.failed++;
                                results.errors.push({
                                    id: item.id,
                                    error: result.message
                                });
                                
                                // Handle retry logic
                                const retryCount = (item.retry_count || 0) + 1;
                                
                                if (retryCount >= CONFIG.SYNC_CONFIG.MAX_RETRIES) {
                                    await updateSyncItemStatus(item.id, 'failed', retryCount);
                                } else {
                                    await updateSyncItemStatus(item.id, 'pending', retryCount);
                                    
                                    // Schedule retry with exponential backoff
                                    const delay = CONFIG.SYNC_CONFIG.EXPONENTIAL_BACKOFF 
                                        ? CONFIG.SYNC_CONFIG.RETRY_DELAY * Math.pow(2, retryCount - 1)
                                        : CONFIG.SYNC_CONFIG.RETRY_DELAY;
                                    
                                    setTimeout(() => syncOrders(), delay);
                                }
                            }
                        } catch (error) {
                            console.error('Error processing sync item:', error);
                            results.failed++;
                            results.errors.push({
                                id: item.id,
                                error: error.message
                            });
                            
                            await updateSyncItemStatus(item.id, 'failed');
                        }
                    });
                    
                    await Promise.all(batchPromises);
                    
                    // Small delay between batches
                    if (i + CONFIG.SYNC_CONFIG.BATCH_SIZE < pendingItems.length) {
                        await delay(500);
                    }
                }
                
                // Update sync status
                updateSyncStatus();
                updateSyncQueueBadge();
                
                hideLoading();
                
                // Show summary
                if (results.success > 0) {
                    showToast(`ซิงค์สำเร็จ ${results.success} รายการ`, 'success');
                }
                if (results.failed > 0) {
                    showToast(`ซิงค์ล้มเหลว ${results.failed} รายการ`, 'warning');
                }
                
                // Refresh data if needed
                if (state.currentView === 'orders') {
                    await loadOrders();
                }
                
            } catch (error) {
                console.error('Error syncing orders:', error);
                hideLoading();
                showToast('เกิดข้อผิดพลาดในการซิงค์ข้อมูล', 'error');
            }
        }

        async function processSyncItem(item) {
            try {
                let result;
                
                switch (item.type) {
                    case 'order':
                        result = await syncOrder(item);
                        break;
                    default:
                        console.warn('Unknown sync item type:', item.type);
                        return { success: false, message: 'Unknown sync type' };
                }
                
                return result;
            } catch (error) {
                console.error('Error processing sync item:', error);
                return { 
                    success: false, 
                    message: error.message 
                };
            }
        }

        async function syncOrder(item) {
            try {
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'saveOrder',
                        data: item.data,
                        timestamp: Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error syncing order:', error);
                return { 
                    success: false, 
                    message: error.message 
                };
            }
        }

        async function updateSyncItemStatus(itemId, status, retryCount = 0) {
            try {
                const transaction = await getDBTransaction([CONFIG.STORES.SYNC_QUEUE], 'readwrite');
                const store = transaction.objectStore(CONFIG.STORES.SYNC_QUEUE);
                
                return new Promise((resolve, reject) => {
                    const request = store.get(itemId);
                    
                    request.onsuccess = () => {
                        const item = request.result;
                        if (item) {
                            item.status = status;
                            item.updated_at = new Date().toISOString();
                            if (retryCount > 0) {
                                item.retry_count = retryCount;
                            }
                            
                            const updateRequest = store.put(item);
                            updateRequest.onsuccess = () => resolve();
                            updateRequest.onerror = (event) => reject(event.target.error);
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (event) => reject(event.target.error);
                });
            } catch (error) {
                console.error('Error updating sync item status:', error);
            }
        }

        async function updateOrderSyncStatus(orderId, synced = true) {
            try {
                const transaction = await getDBTransaction([CONFIG.STORES.ORDERS], 'readwrite');
                const store = transaction.objectStore(CONFIG.STORES.ORDERS);
                
                return new Promise((resolve, reject) => {
                    const request = store.get(orderId);
                    
                    request.onsuccess = () => {
                        const order = request.result;
                        if (order) {
                            order.synced = synced;
                            order.updated_at = new Date().toISOString();
                            
                            const updateRequest = store.put(order);
                            updateRequest.onsuccess = () => resolve();
                            updateRequest.onerror = (event) => reject(event.target.error);
                        } else {
                            resolve();
                        }
                    };
                    
                    request.onerror = (event) => reject(event.target.error);
                });
            } catch (error) {
                console.error('Error updating order sync status:', error);
            }
        }

        function updateSyncQueueBadge() {
            // Get pending sync items count
            getSyncQueue().then(queue => {
                const pendingCount = queue.filter(item => item.status === 'pending').length;
                
                // Update badge in sidebar if exists
                const syncBadge = document.querySelector('.nav-item[data-view="channels"] .nav-badge');
                if (syncBadge) {
                    if (pendingCount > 0) {
                        syncBadge.textContent = pendingCount;
                        syncBadge.style.display = 'inline-block';
                    } else {
                        syncBadge.style.display = 'none';
                    }
                }
            }).catch(error => {
                console.error('Error updating sync queue badge:', error);
            });
        }

        // ===== UI RENDERING =====
        function renderProductsGrid() {
            const container = document.getElementById('productsGrid');
            if (!container) return;
            
            const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
            const activeCategory = document.querySelector('.category-item.active')?.dataset.category || 'ทั้งหมด';
            
            // Filter products
            let filteredProducts = [...state.products];
            
            // Apply search filter
            if (searchTerm) {
                filteredProducts = filteredProducts.filter(product =>
                    (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.category && product.category.toLowerCase().includes(searchTerm))
                );
            }
            
            // Apply category filter
            if (activeCategory !== 'ทั้งหมด') {
                filteredProducts = filteredProducts.filter(product => 
                    product.category === activeCategory
                );
            }
            
            // Sort by stock status and name
            filteredProducts.sort((a, b) => {
                // Out of stock items go to bottom
                const aStock = parseInt(a.stock) || 0;
                const bStock = parseInt(b.stock) || 0;
                
                if (aStock === 0 && bStock > 0) return 1;
                if (bStock === 0 && aStock > 0) return -1;
                
                // Sort by name
                return (a.name || '').localeCompare(b.name || '');
            });
            
            // Update product count
            const productCountEl = document.getElementById('productCount');
            if (productCountEl) {
                productCountEl.textContent = `${filteredProducts.length} รายการ`;
            }
            
            // Clear container
            container.innerHTML = '';
            
            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="grid-column: 1 / -1; padding: 40px;">
                        <i class="bi bi-search" style="font-size: 3rem; color: var(--color-text-muted);"></i>
                        <p class="mt-2 text-muted">ไม่พบสินค้าที่ตรงกับการค้นหา</p>
                        <button class="btn btn-outline mt-3" onclick="fetchProductsFromServer()">
                            <i class="bi bi-arrow-repeat"></i> โหลดสินค้าอีกครั้ง
                        </button>
                    </div>
                `;
                return;
            }
            
            // Render products
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card animate-fade-in';
                productCard.dataset.productId = product.id;
                
                // Stock status
                const stock = parseInt(product.stock) || 0;
                const minStock = parseInt(product.min_stock) || 5;
                
                let stockClass = 'product-stock';
                let stockText = `คงเหลือ: ${stock} ${product.unit || 'ชิ้น'}`;
                
                if (stock <= 0) {
                    stockClass += ' out';
                    stockText = 'สินค้าหมด';
                    productCard.style.opacity = '0.6';
                } else if (stock <= minStock) {
                    stockClass += ' low';
                    stockText += ' (ต่ำกว่าเกณฑ์)';
                }
                
                // Image fallback
                const fallbackImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iIzFlMjkzYiIvPjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5NGEzYjgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ubyBpbWFnZTwvdGV4dD48L3N2Zz4=';
                
                productCard.innerHTML = `
                    <div class="product-image">
                        ${product.image ? 
                            `<img src="${product.image}" alt="${product.name}" loading="lazy" onerror="this.src='${fallbackImage}';">` : 
                            `<i class="bi bi-box-seam" style="font-size: 3rem; color: var(--color-text-muted);"></i>`
                        }
                    </div>
                    <div class="product-name">${product.name || 'Unknown'}</div>
                    <div class="product-price">${formatCurrency(product.price || 0)}</div>
                    <div class="${stockClass}">${stockText}</div>
                `;
                
                // Only add click event if product is in stock
                if (stock > 0) {
                    productCard.addEventListener('click', () => addToCart(product));
                } else {
                    productCard.style.cursor = 'not-allowed';
                    productCard.addEventListener('click', () => {
                        showToast('สินค้าหมดสต็อก', 'warning');
                    });
                }
                
                container.appendChild(productCard);
            });
        }

        function renderCategoryFilter() {
            const menu = document.getElementById('categoryMenu');
            if (!menu) return;
            
            menu.innerHTML = '';
            
            state.categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'category-item';
                item.dataset.category = category;
                item.textContent = category;
                
                if (category === 'ทั้งหมด') {
                    item.classList.add('active');
                }
                
                item.addEventListener('click', () => {
                    // Remove active class from all items
                    document.querySelectorAll('.category-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    item.classList.add('active');
                    
                    // Close menu
                    menu.classList.remove('show');
                    
                    // Filter products
                    renderProductsGrid();
                });
                
                menu.appendChild(item);
            });
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const subtotalEl = document.getElementById('subtotal');
            const taxEl = document.getElementById('tax');
            const totalEl = document.getElementById('totalAmount');
            const totalItemsEl = document.getElementById('totalItems');
            
            if (!container) return;
            
            // Clear container
            container.innerHTML = '';
            
            if (state.cart.items.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="bi bi-cart" style="font-size: 3rem;"></i>
                        <p class="mt-2">ไม่มีสินค้าในตะกร้า</p>
                    </div>
                `;
            } else {
                // Render cart items
                state.cart.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item animate-slide-in';
                    
                    itemEl.innerHTML = `
                        <div class="cart-item-qty">
                            <button class="qty-btn" onclick="updateCartQuantity('${item.id}', -1)">
                                <i class="bi bi-dash"></i>
                            </button>
                            <span class="qty-value">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateCartQuantity('${item.id}', 1)">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatCurrency(item.price * item.quantity)}</div>
                        <button class="cart-item-remove" onclick="removeFromCart('${item.id}')" title="ลบออกจากตะกร้า">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    `;
                    
                    container.appendChild(itemEl);
                });
            }
            
            // Update totals
            if (subtotalEl) subtotalEl.textContent = formatCurrency(state.cart.subtotal);
            if (taxEl) taxEl.textContent = formatCurrency(state.cart.tax);
            if (totalEl) totalEl.textContent = formatCurrency(state.cart.total);
            if (totalItemsEl) {
                const totalQty = state.cart.items.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
                totalItemsEl.textContent = `${totalQty} ชิ้น`;
            }
        }

        function updateCartCount() {
            const cartCountEl = document.getElementById('cartCount');
            if (cartCountEl) {
                const totalQty = state.cart.items.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
                cartCountEl.textContent = totalQty;
            }
        }

        function updateSyncStatus() {
            const syncStatusEl = document.getElementById('syncStatus');
            if (syncStatusEl) {
                if (state.isOnline) {
                    syncStatusEl.className = 'badge badge-success';
                    syncStatusEl.innerHTML = '<i class="bi bi-cloud-check"></i> ออนไลน์';
                } else {
                    syncStatusEl.className = 'badge badge-warning';
                    syncStatusEl.innerHTML = '<i class="bi bi-cloud-off"></i> ออฟไลน์';
                }
            }
        }

        function updateCurrentTime() {
            const timeEl = document.getElementById('currentTime');
            if (timeEl) {
                const now = new Date();
                timeEl.textContent = now.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function showToast(message, type = 'info') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => {
                toast.remove();
            });
            
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const iconMap = {
                success: 'check-circle',
                error: 'x-circle',
                warning: 'exclamation-circle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="bi bi-${iconMap[type] || 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'fadeOut 0.3s ease forwards';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }, 3000);
        }

        function showOrderSuccess(order) {
            Swal.fire({
                title: 'ขายสำเร็จ!',
                html: `
                    <div class="text-center">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <p class="mt-3">ออเดอร์ <strong>${order.id}</strong></p>
                        <p>ยอดรวม: <strong>${formatCurrency(order.total)}</strong></p>
                        <p>วิธีการชำระเงิน: <strong>${order.payment_method === 'cash' ? 'เงินสด' : 'บัตรเครดิต'}</strong></p>
                        <p class="text-small text-muted mt-2">ออเดอร์จะถูกซิงค์อัตโนมัติเมื่อออนไลน์</p>
                    </div>
                `,
                confirmButtonText: 'ตกลง',
                confirmButtonColor: 'var(--color-primary)',
                background: 'var(--color-surface)',
                color: 'var(--color-text)',
                showCloseButton: true
            });
        }

        function printReceipt(order) {
            // Simple print receipt
            const receiptWindow = window.open('', '_blank');
            if (!receiptWindow) {
                showToast('ไม่สามารถเปิดหน้าต่างพิมพ์ได้ กรุณาปิดตัวบล็อกป็อปอัพ', 'warning');
                return;
            }
            
            const receiptContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ใบเสร็จรับเงิน - ${order.id}</title>
                    <meta charset="UTF-8">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500&display=swap');
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        body { 
                            font-family: 'Noto Sans Thai', sans-serif; 
                            padding: 15px; 
                            max-width: 300px; 
                            margin: 0 auto;
                            font-size: 14px;
                            line-height: 1.4;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 15px; 
                            border-bottom: 1px dashed #ccc;
                            padding-bottom: 10px;
                        }
                        .header h2 { 
                            margin: 0; 
                            font-size: 18px;
                            font-weight: bold;
                        }
                        .header p {
                            margin: 5px 0;
                            color: #666;
                            font-size: 12px;
                        }
                        .order-info { 
                            margin-bottom: 15px;
                            font-size: 12px;
                        }
                        .order-info div {
                            margin-bottom: 3px;
                        }
                        .items { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 10px 0; 
                            font-size: 12px;
                        }
                        .items th {
                            text-align: left;
                            padding: 5px 0;
                            border-bottom: 1px dashed #ccc;
                            font-weight: bold;
                        }
                        .items td { 
                            padding: 4px 0; 
                            border-bottom: 1px dashed #ccc; 
                            vertical-align: top;
                        }
                        .items td:last-child {
                            text-align: right;
                            white-space: nowrap;
                        }
                        .items .item-name {
                            width: 60%;
                        }
                        .items .item-qty {
                            width: 15%;
                            text-align: center;
                        }
                        .items .item-price {
                            width: 25%;
                            text-align: right;
                        }
                        .totals {
                            margin-top: 15px;
                            padding-top: 10px;
                            border-top: 1px dashed #333;
                        }
                        .total-row {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 5px;
                        }
                        .total-row.total {
                            font-weight: bold;
                            font-size: 16px;
                            margin-top: 8px;
                            padding-top: 8px;
                            border-top: 2px dashed #333;
                        }
                        .footer { 
                            text-align: center; 
                            margin-top: 20px; 
                            font-size: 11px; 
                            color: #666;
                            padding-top: 10px;
                            border-top: 1px dashed #ccc;
                        }
                        @media print {
                            body { padding: 10px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>Nexus POS</h2>
                        <p>ใบเสร็จรับเงิน</p>
                    </div>
                    
                    <div class="order-info">
                        <div><strong>ออเดอร์:</strong> ${order.id}</div>
                        <div><strong>วันที่:</strong> ${new Date(order.created_at).toLocaleString('th-TH')}</div>
                        <div><strong>ช่องทาง:</strong> ${order.channel === 'store' ? 'หน้าร้าน' : order.channel}</div>
                        <div><strong>การชำระเงิน:</strong> ${order.payment_method === 'cash' ? 'เงินสด' : 'บัตรเครดิต'}</div>
                    </div>
                    
                    <table class="items">
                        <thead>
                            <tr>
                                <th class="item-name">สินค้า</th>
                                <th class="item-qty">จำนวน</th>
                                <th class="item-price">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td class="item-name">${item.name}</td>
                                    <td class="item-qty">${item.quantity}</td>
                                    <td class="item-price">${formatCurrency(item.price * item.quantity)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="totals">
                        <div class="total-row">
                            <span>รวม:</span>
                            <span>${formatCurrency(order.subtotal)}</span>
                        </div>
                        <div class="total-row">
                            <span>ภาษี ${state.settings.taxRate}%:</span>
                            <span>${formatCurrency(order.tax)}</span>
                        </div>
                        <div class="total-row total">
                            <span>รวมสุทธิ:</span>
                            <span>${formatCurrency(order.total)}</span>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>ขอบคุณที่ใช้บริการ</p>
                        <p>Nexus POS 2026</p>
                        <p class="no-print">
                            <button onclick="window.print()" style="padding: 5px 10px; margin: 5px;">พิมพ์ใบเสร็จ</button>
                            <button onclick="window.close()" style="padding: 5px 10px; margin: 5px;">ปิด</button>
                        </p>
                    </div>
                    
                    <script>
                        // Auto print if enabled
                        setTimeout(() => {
                            window.print();
                        }, 500);
                        
                        // Auto close after print
                        window.onafterprint = function() {
                            setTimeout(() => {
                                window.close();
                            }, 1000);
                        };
                    </script>
                </body>
                </html>
            `;
            
            receiptWindow.document.write(receiptContent);
            receiptWindow.document.close();
        }

        function playSound(type) {
            if (!state.settings.soundEnabled) return;
            
            try {
                // Simple beep sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different frequencies for different actions
                oscillator.frequency.value = type === 'add' ? 800 : 600;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (error) {
                // Fallback to silent fail
                console.log('Audio not supported');
            }
        }

        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ===== EVENT LISTENERS =====
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.dataset.view;
                    if (view) {
                        switchView(view);
                    }
                });
            });
            
            // Product search
            const productSearch = document.getElementById('productSearch');
            if (productSearch) {
                let searchTimeout;
                productSearch.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        renderProductsGrid();
                    }, 300);
                });
            }
            
            // Category filter dropdown
            const categoryFilterBtn = document.getElementById('categoryFilterBtn');
            const categoryMenu = document.getElementById('categoryMenu');
            
            if (categoryFilterBtn && categoryMenu) {
                categoryFilterBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    categoryMenu.classList.toggle('show');
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!categoryFilterBtn.contains(e.target) && !categoryMenu.contains(e.target)) {
                        categoryMenu.classList.remove('show');
                    }
                });
            }
            
            // Cart actions
            const clearCartBtn = document.getElementById('clearCartBtn');
            if (clearCartBtn) {
                clearCartBtn.addEventListener('click', clearCart);
            }
            
            // Payment buttons
            const cashPaymentBtn = document.getElementById('cashPaymentBtn');
            if (cashPaymentBtn) {
                cashPaymentBtn.addEventListener('click', () => createOrder('cash'));
            }
            
            const cardPaymentBtn = document.getElementById('cardPaymentBtn');
            if (cardPaymentBtn) {
                cardPaymentBtn.addEventListener('click', () => createOrder('card'));
            }
            
            const cancelOrderBtn = document.getElementById('cancelOrderBtn');
            if (cancelOrderBtn) {
                cancelOrderBtn.addEventListener('click', clearCart);
            }
            
            // Order notes
            const orderNotes = document.getElementById('orderNotes');
            if (orderNotes) {
                orderNotes.addEventListener('change', (e) => {
                    state.cart.notes = e.target.value.trim();
                });
                orderNotes.addEventListener('input', (e) => {
                    state.cart.notes = e.target.value.trim();
                });
            }
            
            // Online/offline detection
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            // Sync orders button
            const syncOrdersBtn = document.getElementById('syncOrdersBtn');
            if (syncOrdersBtn) {
                syncOrdersBtn.addEventListener('click', () => {
                    syncOrders();
                });
            }
            
            // Order status filter
            const orderStatusFilter = document.getElementById('orderStatusFilter');
            if (orderStatusFilter) {
                orderStatusFilter.addEventListener('change', () => {
                    if (state.currentView === 'orders') {
                        renderOrdersTable();
                    }
                });
            }
            
            // Settings button
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', showSettingsModal);
            }
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        }

        function handleOnline() {
            state.isOnline = true;
            updateSyncStatus();
            
            // Hide offline indicator
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (offlineIndicator) {
                offlineIndicator.classList.remove('show');
            }
            
            showToast('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
            
            // Trigger sync after coming online
            setTimeout(() => {
                syncOrders();
            }, 2000);
        }

        function handleOffline() {
            state.isOnline = false;
            updateSyncStatus();
            
            // Show offline indicator
            const offlineIndicator = document.getElementById('offlineIndicator');
            if (offlineIndicator) {
                offlineIndicator.classList.add('show');
            }
            
            showToast('กำลังทำงานในโหมดออฟไลน์', 'warning');
        }

        function showSettingsModal() {
            Swal.fire({
                title: 'ตั้งค่าระบบ',
                html: `
                    <div class="text-start" style="max-width: 400px;">
                        <div class="mb-3">
                            <label for="taxRateInput" class="form-label">อัตราภาษี (%)</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="taxRateInput" 
                                   value="${state.settings.taxRate}" 
                                   min="0" max="20" step="0.1"
                                   style="background: var(--color-surface); color: var(--color-text); border-color: var(--color-border);">
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="autoPrint" 
                                   ${state.settings.autoPrint ? 'checked' : ''}
                                   style="background-color: var(--color-surface);">
                            <label class="form-check-label" for="autoPrint">พิมพ์ใบเสร็จอัตโนมัติ</label>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" 
                                   type="checkbox" 
                                   id="soundEnabled" 
                                   ${state.settings.soundEnabled ? 'checked' : ''}
                                   style="background-color: var(--color-surface);">
                            <label class="form-check-label" for="soundEnabled">เสียงเตือน</label>
                        </div>
                        <div class="mb-3">
                            <label for="syncInterval" class="form-label">ช่วงเวลาซิงค์ (วินาที)</label>
                            <input type="number" 
                                   class="form-control" 
                                   id="syncInterval" 
                                   value="${state.settings.syncInterval / 1000}" 
                                   min="10" max="300"
                                   style="background: var(--color-surface); color: var(--color-text); border-color: var(--color-border);">
                        </div>
                    </div>
                `,
                confirmButtonText: 'บันทึก',
                cancelButtonText: 'ยกเลิก',
                showCancelButton: true,
                confirmButtonColor: 'var(--color-primary)',
                cancelButtonColor: 'var(--color-border)',
                background: 'var(--color-surface)',
                color: 'var(--color-text)',
                width: '500px'
            }).then((result) => {
                if (result.isConfirmed) {
                    const newSettings = {
                        taxRate: parseFloat(document.getElementById('taxRateInput').value) || 7,
                        autoPrint: document.getElementById('autoPrint').checked,
                        soundEnabled: document.getElementById('soundEnabled').checked,
                        syncInterval: (parseFloat(document.getElementById('syncInterval').value) || 30) * 1000
                    };
                    
                    saveSettings(newSettings);
                    showToast('บันทึกการตั้งค่าเรียบร้อย', 'success');
                    
                    // Update cart with new tax rate
                    updateCart();
                }
            });
        }

        function handleLogout(e) {
            e.preventDefault();
            
            Swal.fire({
                title: 'ออกจากระบบ',
                text: 'ต้องการออกจากระบบใช่หรือไม่?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ออกจากระบบ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: 'var(--color-danger)',
                cancelButtonColor: 'var(--color-primary)',
                background: 'var(--color-surface)',
                color: 'var(--color-text)'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        showLoading();
                        
                        // Sync any pending orders before logout
                        if (state.isOnline) {
                            await syncOrders();
                        }
                        
                        // Clear IndexedDB
                        if (db) {
                            db.close();
                        }
                        indexedDB.deleteDatabase(CONFIG.DB_NAME);
                        
                        // Clear localStorage
                        localStorage.clear();
                        
                        // Clear state
                        state = {
                            products: [],
                            cart: { items: [], subtotal: 0, tax: 0, total: 0, notes: '' },
                            orders: [],
                            currentView: 'pos',
                            isOnline: navigator.onLine,
                            syncQueue: [],
                            settings: {
                                taxRate: 7,
                                autoPrint: true,
                                soundEnabled: true,
                                syncInterval: 30000
                            },
                            initialized: false,
                            categories: []
                        };
                        
                        hideLoading();
                        
                        // Reload page
                        location.reload();
                        
                    } catch (error) {
                        console.error('Error during logout:', error);
                        hideLoading();
                        showToast('เกิดข้อผิดพลาดในการออกจากระบบ', 'error');
                    }
                }
            });
        }

        function switchView(view) {
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === view);
            });
            
            // Hide all views
            document.querySelectorAll('.view-container').forEach(container => {
                container.classList.add('d-none');
            });
            
            // Show selected view
            const targetView = document.getElementById(`${view}View`);
            if (targetView) {
                targetView.classList.remove('d-none');
            }
            
            // Update state
            state.currentView = view;
            
            // Load data for view if needed
            switch (view) {
                case 'orders':
                    loadOrders();
                    break;
                case 'products':
                    renderProductsTable();
                    break;
                case 'inventory':
                    renderInventoryView();
                    break;
                case 'reports':
                    renderReportsView();
                    break;
                case 'channels':
                    renderChannelsView();
                    break;
                case 'customers':
                    renderCustomersView();
                    break;
            }
        }

        async function loadOrders() {
            try {
                showLoading();
                const orders = await getFromDB(CONFIG.STORES.ORDERS);
                
                // Filter out cart and get only actual orders
                state.orders = orders.filter(order => 
                    order && order.id && !order.id.startsWith('cart_') && order.type !== 'cart'
                );
                
                renderOrdersTable();
                hideLoading();
            } catch (error) {
                console.error('Error loading orders:', error);
                hideLoading();
                showToast('ไม่สามารถโหลดออเดอร์ได้', 'error');
            }
        }

        function renderOrdersTable() {
            const container = document.getElementById('ordersTable');
            if (!container) return;
            
            // Filter orders by status
            const statusFilter = document.getElementById('orderStatusFilter')?.value || 'all';
            let filteredOrders = [...state.orders];
            
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }
            
            // Sort by date (newest first)
            filteredOrders.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // Clear container
            container.innerHTML = '';
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="bi bi-receipt" style="font-size: 2rem;"></i>
                            <p class="mt-2">ไม่มีออเดอร์</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Render orders
            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                
                // Format date
                const orderDate = new Date(order.created_at);
                const dateStr = orderDate.toLocaleDateString('th-TH', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }) + '<br>' + orderDate.toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Status badge
                let statusBadge = '';
                let statusText = '';
                
                switch (order.status) {
                    case 'pending':
                        statusBadge = 'badge-warning';
                        statusText = 'รอดำเนินการ';
                        break;
                    case 'paid':
                        statusBadge = 'badge-info';
                        statusText = 'ชำระเงินแล้ว';
                        break;
                    case 'completed':
                        statusBadge = 'badge-success';
                        statusText = 'สำเร็จ';
                        break;
                    case 'cancelled':
                        statusBadge = 'badge-danger';
                        statusText = 'ยกเลิก';
                        break;
                    default:
                        statusBadge = 'badge-secondary';
                        statusText = order.status || 'unknown';
                }
                
                // Channel icon
                let channelIcon = '';
                let channelText = '';
                
                switch (order.channel) {
                    case 'store':
                        channelIcon = 'bi-shop';
                        channelText = 'หน้าร้าน';
                        break;
                    case 'shopee':
                        channelIcon = 'bi-basket';
                        channelText = 'Shopee';
                        break;
                    case 'lazada':
                        channelIcon = 'bi-box';
                        channelText = 'Lazada';
                        break;
                    case 'line':
                        channelIcon = 'bi-chat-dots';
                        channelText = 'LINE';
                        break;
                    case 'facebook':
                        channelIcon = 'bi-facebook';
                        channelText = 'Facebook';
                        break;
                    default:
                        channelIcon = 'bi-question-circle';
                        channelText = order.channel || 'unknown';
                }
                
                // Calculate total items
                const totalItems = Array.isArray(order.items) 
                    ? order.items.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0)
                    : 0;
                
                row.innerHTML = `
                    <td><strong>${order.id}</strong></td>
                    <td>${dateStr}</td>
                    <td><i class="bi ${channelIcon}" title="${channelText}"></i> ${channelText}</td>
                    <td>${totalItems} ชิ้น</td>
                    <td>${formatCurrency(order.total || 0)}</td>
                    <td>
                        <span class="badge ${statusBadge}">${statusText}</span>
                        ${!order.synced ? '<i class="bi bi-cloud-upload text-warning ms-1" title="รอซิงค์"></i>' : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewOrderDetail('${order.id}')" title="ดูรายละเอียด">
                            <i class="bi bi-eye"></i>
                        </button>
                        ${order.status === 'pending' ? `
                            <button class="btn btn-sm btn-success ms-1" onclick="completeOrder('${order.id}')" title="ทำเครื่องหมายว่าสำเร็จ">
                                <i class="bi bi-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger ms-1" onclick="cancelOrder('${order.id}')" title="ยกเลิกออเดอร์">
                                <i class="bi bi-x"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                container.appendChild(row);
            });
        }

        function renderProductsTable() {
            const container = document.getElementById('productsTable');
            if (!container) return;
            
            container.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> ฟังก์ชันจัดการสินค้าจะเปิดให้ใช้งานเร็วๆ นี้
                        </div>
                        <button class="btn btn-primary" onclick="fetchProductsFromServer()">
                            <i class="bi bi-arrow-repeat"></i> รีเฟรชสินค้าจากเซิร์ฟเวอร์
                        </button>
                    </td>
                </tr>
            `;
        }

        function renderInventoryView() {
            const container = document.getElementById('inventoryContent');
            if (!container) return;
            
            // Calculate inventory stats
            const lowStockProducts = state.products.filter(p => {
                const stock = parseInt(p.stock) || 0;
                const minStock = parseInt(p.min_stock) || 5;
                return stock > 0 && stock <= minStock;
            });
            
            const outOfStockProducts = state.products.filter(p => {
                const stock = parseInt(p.stock) || 0;
                return stock <= 0;
            });
            
            const healthyStockProducts = state.products.filter(p => {
                const stock = parseInt(p.stock) || 0;
                const minStock = parseInt(p.min_stock) || 5;
                return stock > minStock;
            });
            
            // Calculate total inventory value
            const totalInventoryValue = state.products.reduce((total, product) => {
                const stock = parseInt(product.stock) || 0;
                const price = parseFloat(product.price) || 0;
                return total + (stock * price);
            }, 0);
            
            container.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${state.products.length}</h5>
                                <p class="card-text text-muted">สินค้าทั้งหมด</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-success">${healthyStockProducts.length}</h5>
                                <p class="card-text text-muted">สต็อกปกติ</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-warning">${lowStockProducts.length}</h5>
                                <p class="card-text text-muted">เกือบหมด</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title text-danger">${outOfStockProducts.length}</h5>
                                <p class="card-text text-muted">สินค้าหมด</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="bi bi-exclamation-triangle text-warning"></i> สินค้าเกือบหมด</h5>
                            </div>
                            <div class="card-body">
                                ${lowStockProducts.length === 0 ? 
                                    '<p class="text-muted text-center">ไม่มีสินค้าเกือบหมด</p>' : 
                                    `<div class="list-group">
                                        ${lowStockProducts.slice(0, 5).map(p => `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${p.name}</strong><br>
                                                    <small class="text-muted">SKU: ${p.sku || '-'}</small>
                                                </div>
                                                <span class="badge bg-warning">${p.stock} ${p.unit || 'ชิ้น'}</span>
                                            </div>
                                        `).join('')}
                                        ${lowStockProducts.length > 5 ? 
                                            `<div class="text-center mt-2">
                                                <small class="text-muted">และอีก ${lowStockProducts.length - 5} รายการ</small>
                                            </div>` : ''
                                        }
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0"><i class="bi bi-x-circle text-danger"></i> สินค้าหมด</h5>
                            </div>
                            <div class="card-body">
                                ${outOfStockProducts.length === 0 ? 
                                    '<p class="text-muted text-center">ไม่มีสินค้าหมด</p>' : 
                                    `<div class="list-group">
                                        ${outOfStockProducts.slice(0, 5).map(p => `
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>${p.name}</strong><br>
                                                    <small class="text-muted">SKU: ${p.sku || '-'}</small>
                                                </div>
                                                <span class="badge bg-danger">หมด</span>
                                            </div>
                                        `).join('')}
                                        ${outOfStockProducts.length > 5 ? 
                                            `<div class="text-center mt-2">
                                                <small class="text-muted">และอีก ${outOfStockProducts.length - 5} รายการ</small>
                                            </div>` : ''
                                        }
                                    </div>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-pie-chart"></i> สรุปมูลค่าสต็อก</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <h3>${formatCurrency(totalInventoryValue)}</h3>
                            <p class="text-muted">มูลค่าสต็อกรวมทั้งหมด</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderReportsView() {
            const container = document.getElementById('reportContent');
            if (!container) return;
            
            const today = new Date().toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Calculate today's stats from local orders
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            
            const todayOrders = state.orders.filter(order => {
                const orderDate = new Date(order.created_at);
                return orderDate >= todayStart && order.status !== 'cancelled';
            });
            
            const todayRevenue = todayOrders.reduce((total, order) => total + (parseFloat(order.total) || 0), 0);
            const todayOrderCount = todayOrders.length;
            
            container.innerHTML = `
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${todayOrderCount}</h5>
                                <p class="card-text text-muted">ออเดอร์วันนี้</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${formatCurrency(todayRevenue)}</h5>
                                <p class="card-text text-muted">รายได้วันนี้</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h5 class="card-title">${state.orders.length}</h5>
                                <p class="card-text text-muted">ออเดอร์ทั้งหมด</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ฟังก์ชันรายงานขั้นสูงจะเปิดให้ใช้งานเร็วๆ นี้
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">รายงานประจำวันที่ ${today}</h5>
                        <div class="mt-3">
                            <p><strong>ออเดอร์วันนี้:</strong> ${todayOrderCount} ออเดอร์</p>
                            <p><strong>รายได้วันนี้:</strong> ${formatCurrency(todayRevenue)}</p>
                            <p><strong>ออเดอร์ที่รอซิงค์:</strong> ${state.orders.filter(o => !o.synced).length} ออเดอร์</p>
                        </div>
                        <div class="mt-4">
                            <button class="btn btn-primary" onclick="generateDailyReport()">
                                <i class="bi bi-file-earmark-bar-graph"></i> สร้างรายงานจากเซิร์ฟเวอร์
                            </button>
                            <button class="btn btn-outline ms-2" onclick="syncOrders()">
                                <i class="bi bi-arrow-repeat"></i> ซิงค์ข้อมูลล่าสุด
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderChannelsView() {
            const container = document.getElementById('channelsContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-shop" style="font-size: 3rem; color: var(--color-primary);"></i>
                            <h5 class="card-title mt-2">หน้าร้าน</h5>
                            <p class="text-muted">ขายหน้าร้าน</p>
                            <div class="badge bg-success">เชื่อมต่อแล้ว</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-basket" style="font-size: 3rem; color: orange;"></i>
                            <h5 class="card-title mt-2">Shopee</h5>
                            <p class="text-muted">ร้านค้าออนไลน์</p>
                            <button class="btn btn-outline btn-sm">เชื่อมต่อ</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-box" style="font-size: 3rem; color: blue;"></i>
                            <h5 class="card-title mt-2">Lazada</h5>
                            <p class="text-muted">ร้านค้าออนไลน์</p>
                            <button class="btn btn-outline btn-sm">เชื่อมต่อ</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-chat-dots" style="font-size: 3rem; color: green;"></i>
                            <h5 class="card-title mt-2">LINE</h5>
                            <p class="text-muted">แชทขาย</p>
                            <button class="btn btn-outline btn-sm">เชื่อมต่อ</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <i class="bi bi-facebook" style="font-size: 3rem; color: #1877F2;"></i>
                            <h5 class="card-title mt-2">Facebook</h5>
                            <p class="text-muted">ร้านค้าออนไลน์</p>
                            <button class="btn btn-outline btn-sm">เชื่อมต่อ</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomersView() {
            const container = document.getElementById('customersContent');
            if (!container) return;
            
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> ฟังก์ชันจัดการลูกค้าจะเปิดให้ใช้งานเร็วๆ นี้
                </div>
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-people" style="font-size: 4rem; color: var(--color-text-muted);"></i>
                        <h5 class="card-title mt-3">ระบบจัดการลูกค้า</h5>
                        <p class="text-muted">กำลังเตรียมการ...</p>
                        <div class="mt-4">
                            <button class="btn btn-outline" disabled>
                                <i class="bi bi-person-plus"></i> เพิ่มลูกค้า (เร็วๆ นี้)
                            </button>
                            <button class="btn btn-outline ms-2" onclick="switchView('reports')">
                                <i class="bi bi-bar-chart"></i> ดูรายงานลูกค้า
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ===== GLOBAL FUNCTIONS (for HTML onclick) =====
        window.updateCartQuantity = updateCartQuantity;
        window.removeFromCart = removeFromCart;
        window.fetchProductsFromServer = fetchProductsFromServer;
        window.syncOrders = syncOrders;
        
        window.viewOrderDetail = async function(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (!order) {
                showToast('ไม่พบออเดอร์', 'error');
                return;
            }
            
            // Format items for display
            const itemsHtml = Array.isArray(order.items) ? order.items.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center">${item.quantity}</td>
                    <td class="text-right">${formatCurrency(item.price)}</td>
                    <td class="text-right">${formatCurrency(item.price * item.quantity)}</td>
                </tr>
            `).join('') : '';
            
            Swal.fire({
                title: `รายละเอียดออเดอร์ ${order.id}`,
                html: `
                    <div class="text-start" style="max-height: 60vh; overflow-y: auto; font-size: 14px;">
                        <p><strong>ช่องทาง:</strong> ${order.channel}</p>
                        <p><strong>วันที่:</strong> ${new Date(order.created_at).toLocaleString('th-TH')}</p>
                        <p><strong>สถานะ:</strong> ${order.status}</p>
                        <p><strong>การชำระเงิน:</strong> ${order.payment_method === 'cash' ? 'เงินสด' : 'บัตรเครดิต'}</p>
                        <p><strong>หมายเหตุ:</strong> ${order.notes || '-'}</p>
                        <p><strong>ซิงค์แล้ว:</strong> ${order.synced ? 'ใช่' : 'ยังไม่ซิงค์'}</p>
                        <hr>
                        <h6>รายการสินค้า:</h6>
                        <table style="width: 100%;" class="table table-sm">
                            <thead>
                                <tr>
                                    <th>สินค้า</th>
                                    <th class="text-center">จำนวน</th>
                                    <th class="text-right">ราคา</th>
                                    <th class="text-right">รวม</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHtml}
                            </tbody>
                        </table>
                        <hr>
                        <p><strong>รวม:</strong> ${formatCurrency(order.subtotal)}</p>
                        <p><strong>ภาษี:</strong> ${formatCurrency(order.tax)}</p>
                        <p><strong>รวมสุทธิ:</strong> ${formatCurrency(order.total)}</p>
                    </div>
                `,
                confirmButtonText: 'ปิด',
                showCancelButton: true,
                cancelButtonText: 'พิมพ์ใบเสร็จ',
                confirmButtonColor: 'var(--color-primary)',
                cancelButtonColor: 'var(--color-success)',
                background: 'var(--color-surface)',
                color: 'var(--color-text)',
                width: '700px'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    printReceipt(order);
                }
            });
        };
        
        window.completeOrder = async function(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (order) {
                order.status = 'completed';
                order.updated_at = new Date().toISOString();
                
                await saveToDB(CONFIG.STORES.ORDERS, order);
                await addToSyncQueue({
                    type: 'order',
                    action: 'update',
                    data: order,
                    created_at: new Date().toISOString(),
                    status: 'pending'
                });
                
                renderOrdersTable();
                showToast('อัปเดตสถานะออเดอร์เรียบร้อย', 'success');
                
                if (state.isOnline) {
                    setTimeout(() => syncOrders(), 1000);
                }
            }
        };
        
        window.cancelOrder = async function(orderId) {
            const order = state.orders.find(o => o.id === orderId);
            if (order) {
                Swal.fire({
                    title: 'ยืนยันการยกเลิกออเดอร์',
                    text: `ต้องการยกเลิกออเดอร์ ${orderId} ใช่หรือไม่?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ยกเลิกออเดอร์',
                    cancelButtonText: 'ไม่ยกเลิก',
                    confirmButtonColor: 'var(--color-danger)',
                    cancelButtonColor: 'var(--color-primary)',
                    background: 'var(--color-surface)',
                    color: 'var(--color-text)'
                }).then(async (result) => {
                    if (result.isConfirmed) {
                        order.status = 'cancelled';
                        order.updated_at = new Date().toISOString();
                        
                        await saveToDB(CONFIG.STORES.ORDERS, order);
                        await addToSyncQueue({
                            type: 'order',
                            action: 'update',
                            data: order,
                            created_at: new Date().toISOString(),
                            status: 'pending'
                        });
                        
                        renderOrdersTable();
                        showToast('ยกเลิกออเดอร์เรียบร้อยแล้ว', 'success');
                        
                        if (state.isOnline) {
                            setTimeout(() => syncOrders(), 1000);
                        }
                    }
                });
            }
        };
        
        window.generateDailyReport = async function() {
            try {
                if (!state.isOnline) {
                    showToast('ต้องเชื่อมต่ออินเทอร์เน็ตเพื่อสร้างรายงาน', 'warning');
                    return;
                }
                
                showLoading();
                
                const response = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'generateDailyReport',
                        date: new Date().toISOString().split('T')[0]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    Swal.fire({
                        title: 'รายงานประจำวัน',
                        html: `
                            <div class="text-start" style="max-height: 60vh; overflow-y: auto;">
                                <p><strong>วันที่:</strong> ${result.date}</p>
                                <p><strong>จำนวนออเดอร์:</strong> ${result.orderCount} ออเดอร์</p>
                                <hr>
                                <h6>สรุปยอด:</h6>
                                <p><strong>ทั้งหมด:</strong> ${result.totals?.all?.count || 0} ออเดอร์ (${formatCurrency(result.totals?.all?.revenue || 0)})</p>
                                <p><strong>สำเร็จ:</strong> ${result.totals?.completed?.count || 0} ออเดอร์ (${formatCurrency(result.totals?.completed?.revenue || 0)})</p>
                                <p><strong>ยกเลิก:</strong> ${result.totals?.cancelled?.count || 0} ออเดอร์ (${formatCurrency(result.totals?.cancelled?.revenue || 0)})</p>
                                ${result.byChannel ? `
                                    <hr>
                                    <h6>รายได้แยกตามช่องทาง:</h6>
                                    ${Object.entries(result.byChannel).map(([channel, data]) => `
                                        <p><strong>${channel}:</strong> ${data.count} ออเดอร์ (${formatCurrency(data.revenue)})</p>
                                    `).join('')}
                                ` : ''}
                            </div>
                        `,
                        confirmButtonText: 'ตกลง',
                        confirmButtonColor: 'var(--color-primary)',
                        background: 'var(--color-surface)',
                        color: 'var(--color-text)',
                        width: '600px'
                    });
                } else {
                    throw new Error(result.message || 'Failed to generate report');
                }
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('ไม่สามารถสร้างรายงานได้: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        };

        // ===== INITIALIZATION =====
        async function initializeApp() {
            console.log(`${CONFIG.APP_NAME} v${CONFIG.VERSION} กำลังเริ่มต้น...`);
            
            try {
                showLoading();
                
                // Initialize IndexedDB
                await initDB();
                
                // Load settings
                await loadSettings();
                
                // Load products
                await loadProducts();
                
                // Load cart (after products are loaded)
                await loadCartFromDB();
                
                // Set up event listeners
                setupEventListeners();
                
                // Update UI
                updateCart();
                updateSyncStatus();
                updateCurrentTime();
                updateSyncQueueBadge();
                
                // Start time updater
                setInterval(updateCurrentTime, 1000);
                
                // Start periodic sync if online
                if (state.isOnline) {
                    // Initial sync after 2 seconds
                    setTimeout(() => syncOrders(), 2000);
                    
                    // Periodic sync
                    setInterval(() => {
                        if (state.isOnline) {
                            syncOrders();
                        }
                    }, state.settings.syncInterval);
                }
                
                // Set offline indicator if offline
                if (!state.isOnline) {
                    document.getElementById('offlineIndicator').classList.add('show');
                }
                
                hideLoading();
                
                console.log('แอปพลิเคชันพร้อมใช้งาน');
                showToast(`${CONFIG.APP_NAME} พร้อมใช้งาน`, 'success');
                
                state.initialized = true;
                
            } catch (error) {
                console.error('Error initializing app:', error);
                hideLoading();
                
                // Show user-friendly error message
                const errorMessage = error.message || 'Unknown error';
                showToast(`เกิดข้อผิดพลาดในการเริ่มต้นแอปพลิเคชัน: ${errorMessage}`, 'error');
                
                // Fallback to basic functionality
                try {
                    renderProductsGrid();
                    updateCart();
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                }
            }
        }

        // Start the app when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
