<script>
    // Configuration
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyG7j1HBNUcLs2iKJVJVt0JMAcjyKzxIAyHUdQTCNYGcmKqu4UZz0hs9MEKkMKLBgvg7g/exec";
    let products = [];
    let orders = [];
    let cart = [];
    let salesChart = null;
    let productsChart = null;
    let updateInterval = null;
    let settings = {};

    // Cache Functions
    const CACHE_PREFIX = 'pos_cache_';

    function saveToCache(key, data) {
        try {
            localStorage.setItem(CACHE_PREFIX + key, JSON.stringify({
                timestamp: new Date().getTime(),
                data: data
            }));
        } catch (e) {
            console.warn('Cache save failed', e);
        }
    }

    function loadFromCache(key) {
        try {
            const cached = localStorage.getItem(CACHE_PREFIX + key);
            if (cached) {
                return JSON.parse(cached).data;
            }
        } catch (e) {
            console.warn('Cache load failed', e);
        }
        return null;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Set last updated time
        document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('th-TH');

        // Apply saved theme
        const savedTheme = localStorage.getItem('selectedTheme') || 'dark';
        applyTheme(savedTheme);

        // Initialize view mode
        setupViewModeToggle();

        // Check if system is initialized
        checkSystemStatus();

        // Setup event listeners
        setupEventListeners();

        // Initialize live updates
        startLiveUpdates();
    });

    function setupEventListeners() {
        // Theme toggle
        document.querySelectorAll('[data-theme]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                applyTheme(e.target.closest('[data-theme]').dataset.theme);
            });
        });

        // View mode toggle
        document.getElementById('viewModeToggle').addEventListener('change', function () {
            toggleViewMode(this.checked);
        });

        // Admin login/logout
        document.getElementById('admin-login-btn').addEventListener('click', showAdminLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        // Order notes input
        document.getElementById('order-notes').addEventListener('keyup', function (e) {
            if (e.key === 'Enter') {
                checkout();
            }
        });

        // Tab change
        document.querySelectorAll('#adminTabs button').forEach(tab => {
            tab.addEventListener('shown.bs.tab', event => {
                if (event.target.id === 'reports-tab') {
                    initCharts();
                }
            });
        });
    }

    function applyTheme(themeName) {
        document.documentElement.setAttribute('data-theme', themeName);
        localStorage.setItem('selectedTheme', themeName);

        // Update chart colors if they exist
        updateChartColors();
    }

    function setupViewModeToggle() {
        const toggle = document.getElementById('viewModeToggle');
        const savedViewMode = localStorage.getItem('viewMode') || 'grid';
        toggle.checked = savedViewMode === 'image';
        toggleViewMode(toggle.checked);
    }

    function toggleViewMode(showImages) {
        const productGrid = document.getElementById('product-grid-view');
        const listView = document.getElementById('list-view');

        if (showImages) {
            productGrid.classList.remove('d-none');
            listView.classList.add('d-none');
            localStorage.setItem('viewMode', 'image');
            renderProductGrid();
        } else {
            productGrid.classList.add('d-none');
            listView.classList.remove('d-none');
            localStorage.setItem('viewMode', 'list');
            renderQuickSelect();
        }
    }

    function jsonpRequest(url, callback) {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = function (data) {
            delete window[callbackName];
            document.body.removeChild(script);
            callback(data);
        };
        const script = document.createElement('script');
        script.src = `${url}${(url.includes('?') ? '&' : '?')}callback=${callbackName}`;
        document.body.appendChild(script);
    }

    function checkSystemStatus() {
        jsonpRequest(`${SCRIPT_URL}?action=getProducts`, data => {
            if (Array.isArray(data)) {
                // System is initialized
                document.getElementById('init-prompt').style.display = 'none';
                document.getElementById('pos-system').style.display = 'block';
                fetchAllData();
            } else {
                // System not initialized
                document.getElementById('init-prompt').style.display = 'block';
                document.getElementById('pos-system').style.display = 'none';
            }
        });
    }

    function initializePOSSystem() {
        Swal.fire({
            title: 'กำลังเริ่มต้นระบบ POS...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        jsonpRequest(`${SCRIPT_URL}?action=initializePOS`, response => {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'สำเร็จ!',
                    html: `
                        <div class="text-start">
                            <p>สร้างแผ่นงานระบบ POS สำเร็จแล้ว:</p>
                            <ul class="mt-2">
                                <li>✅ products - จัดการสินค้า</li>
                                <li>✅ orders - คำสั่งซื้อ</li>
                                <li>✅ inventory_log - ประวัติสต็อก</li>
                                <li>✅ settings - การตั้งค่า</li>
                            </ul>
                            <p class="mt-3 text-sm">ระบบพร้อมใช้งานแล้ว!</p>
                        </div>
                    `,
                    confirmButtonText: 'ตกลง'
                });

                document.getElementById('init-prompt').style.display = 'none';
                document.getElementById('pos-system').style.display = 'block';
                fetchAllData();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'ผิดพลาด',
                    text: response.message
                });
            }
        });
    }

    function fetchAllData() {
        fetchProducts();
        fetchOrders();
        fetchSettings();
        if (document.getElementById('admin-view').style.display === 'block') {
            fetchDashboardStats();
            fetchInventoryLog();
        }
    }

    function fetchProducts() {
        // Try cache first
        const cached = loadFromCache('products');
        if (cached) {
            products = cached;
            updateQuickStats();
            renderProductGrid();
            renderQuickSelect();
            renderCategoryFilters();
            if (document.getElementById('admin-view').style.display === 'block') {
                renderAdminProductsTable();
                renderLowStockItems();
            }
        }

        jsonpRequest(`${SCRIPT_URL}?action=getProducts`, data => {
            products = data;
            saveToCache('products', data); // Save to cache

            updateQuickStats();
            renderProductGrid();
            renderQuickSelect();
            renderCategoryFilters();
            if (document.getElementById('admin-view').style.display === 'block') {
                renderAdminProductsTable();
                renderLowStockItems();
            }
        });
    }

    function fetchOrders() {
        // Try cache first
        const cached = loadFromCache('orders');
        if (cached) {
            orders = cached;
            updateQuickStats();
            renderRecentOrdersTable();
            if (document.getElementById('admin-view').style.display === 'block') {
                renderAdminOrdersTable();
                updateLiveStats();
            }
        }

        jsonpRequest(`${SCRIPT_URL}?action=getOrders`, data => {
            const newOrders = data.reverse(); // Show newest first

            // Basic diff check could be done here, but for now just overwrite
            orders = newOrders;
            saveToCache('orders', orders);

            updateQuickStats();
            renderRecentOrdersTable();
            if (document.getElementById('admin-view').style.display === 'block') {
                renderAdminOrdersTable();
                updateLiveStats();
            }
        });
    }

    function fetchSettings() {
        const cached = loadFromCache('settings');
        if (cached) {
            settings = cached;
            updateSettingsUI();
        }

        jsonpRequest(`${SCRIPT_URL}?action=getSettings`, data => {
            settings = data;
            saveToCache('settings', data);
            updateSettingsUI();

            // Re-render currency dependent items if needed
            updateCartUI();
        });
    }

    function fetchDashboardStats() {
        jsonpRequest(`${SCRIPT_URL}?action=getDashboardStats`, response => {
            if (response.result === 'success') {
                renderDashboard(response.stats);
            }
        });
    }

    function fetchInventoryLog() {
        jsonpRequest(`${SCRIPT_URL}?action=getInventoryLog`, data => {
            renderInventoryLogTable(data);
        });
    }

    function updateQuickStats() {
        // Calculate stats
        const totalProducts = products.length;

        const today = new Date().toISOString().split('T')[0];
        const todayOrders = orders.filter(order => {
            const orderDate = new Date(order.created_at).toISOString().split('T')[0];
            return orderDate === today;
        });
        const todaySales = todayOrders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);

        const totalOrders = orders.length;

        const lowStockThreshold = parseInt(settings.low_stock_threshold || 10);
        const lowStockProducts = products.filter(p => parseInt(p.stock) <= lowStockThreshold && parseInt(p.stock) > 0).length;

        // Update UI
        document.getElementById('total-products').textContent = totalProducts;
        document.getElementById('today-sales').textContent = formatCurrency(todaySales);
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('low-stock-count').textContent = lowStockProducts;
    }

    function updateLiveStats() {
        const today = new Date().toISOString().split('T')[0];
        const todayOrders = orders.filter(order => {
            const orderDate = new Date(order.created_at).toISOString().split('T')[0];
            return orderDate === today;
        });
        const todaySales = todayOrders.reduce((sum, order) => sum + parseFloat(order.total || 0), 0);

        document.getElementById('live-sales-today').textContent = formatCurrency(todaySales);
    }

    function updateSettingsUI() {
        if (settings.store_name) {
            document.getElementById('store-name').value = settings.store_name;
        }
        if (settings.tax_rate) {
            document.getElementById('tax-rate').value = settings.tax_rate;
        }
        if (settings.currency) {
            document.getElementById('currency').value = settings.currency;
        }
        if (settings.low_stock_threshold) {
            document.getElementById('low-stock-threshold').value = settings.low_stock_threshold;
        }
        if (settings.receipt_header) {
            document.getElementById('receipt-header').value = settings.receipt_header;
        }
        if (settings.receipt_footer) {
            document.getElementById('receipt-footer').value = settings.receipt_footer;
        }
    }

    function startLiveUpdates() {
        updateInterval = setInterval(() => {
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString('th-TH');
        }, 60000);
    }

    // Formatting Functions
    function formatCurrency(amount) {
        return new Intl.NumberFormat('th-TH', {
            style: 'currency',
            currency: settings.currency || 'THB',
            minimumFractionDigits: 2
        }).format(amount || 0);
    }

    // Product Functions
    function getOptimizedProductImage(product) {
        if (!product.image || product.image.trim() === '') {
            // ถ้าไม่มีรูป ให้สร้าง placeholder ที่เหมาะสม
            const firstTwoLetters = product.name.substring(0, 2).toUpperCase();
            const color = parseInt(product.stock) <= 0 ? 'dc2626' :
                parseInt(product.stock) <= 5 ? 'f59e0b' : '10b981';

            // สร้าง placeholder ที่มีอัตราส่วน 1:1 (ตามข้อกำหนด)
            return `https://via.placeholder.com/120x120/${color}/ffffff?text=${encodeURIComponent(firstTwoLetters)}`;
        }

        // ถ้ามี URL รูปภาพ ให้ตรวจสอบว่าตรงกับข้อกำหนดหรือไม่
        const imageUrl = product.image;

        // ตรวจสอบว่าเป็นรูปที่ยาวเกินไปหรือไม่ (ตามข้อกำหนด "ห้ามรูปยาวๆ")
        // ในระบบจริงอาจจะต้องมีการประมวลผลเพิ่มเติม
        return imageUrl;
    }

    function renderProductGrid() {
        const container = document.getElementById('product-grid-view');
        if (!container) return;

        container.innerHTML = '';

        if (products.length === 0) {
            container.innerHTML = '<div class="text-center py-5" style="grid-column: 1 / -1;"><i class="bi bi-box-seam" style="font-size: 3rem; color: var(--text-secondary);"></i><p class="mt-3">ไม่มีรายการสินค้า</p></div>';
            return;
        }

        const activeCategory = document.querySelector('#category-filters .active')?.dataset.category || 'all';
        const filteredProducts = activeCategory === 'all'
            ? products
            : products.filter(p => p.category === activeCategory);

        filteredProducts.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-card hover-lift';
            card.onclick = () => addToCart(product);

            // ตรวจสอบสถานะสต็อก
            const stock = parseInt(product.stock);
            let stockClass = 'normal';
            let stockText = 'พร้อมขาย';

            if (stock <= 0) {
                stockClass = 'out';
                stockText = 'หมดสต็อก';
            } else if (stock <= 5) {
                stockClass = 'low';
                stockText = 'เหลือน้อย';
            }

            // สร้าง URL รูปภาพที่เหมาะสม
            const imageUrl = getOptimizedProductImage(product);

            card.innerHTML = `
                <div class="product-category">${product.category || 'ทั่วไป'}</div>
                
                <div class="product-image">
                    <img src="${imageUrl}" alt="${product.name}" loading="lazy" onerror="this.src='https://via.placeholder.com/120x120/475569/ffffff?text=รูปสินค้า'">
                </div>
                
                <div class="product-price">${formatCurrency(product.price)}</div>
                
                <div class="product-name">${product.name}</div>
                
                <div class="product-code">${product.sku || product.id}</div>
                
                <div class="product-stock ${stockClass}">
                    <i class="bi bi-box-seam me-1"></i>${stockText} (${stock})
                </div>
                
                <div class="product-actions">
                    <button><i class="bi bi-plus-lg"></i></button>
                </div>
            `;

            if (stock <= 0) {
                card.style.opacity = '0.7';
                card.onclick = null;
                card.style.cursor = 'not-allowed';
            }

            container.appendChild(card);
        });
    }

    function renderQuickSelect() {
        const select = document.getElementById('quick-select-product');
        if (!select) return;

        select.innerHTML = '<option selected disabled>เลือกสินค้า...</option>';

        products.forEach(product => {
            if (parseInt(product.stock) > 0) {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} - ${formatCurrency(product.price)}`;
                select.appendChild(option);
            }
        });

        select.onchange = function () {
            const productId = this.value;
            const product = products.find(p => p.id === productId);
            if (product) {
                addToCart(product);
                this.value = 'เลือกสินค้า...'; // Reset
            }
        };
    }

    function renderCategoryFilters() {
        const container = document.getElementById('category-filters');
        if (!container) return;

        // Get unique categories
        const categories = ['all', ...new Set(products.map(p => p.category || 'ทั่วไป'))];

        container.innerHTML = '';

        categories.forEach((category, index) => {
            const btn = document.createElement('button');
            btn.className = `btn btn-sm ${index === 0 ? 'btn-primary' : 'btn-outline-secondary'} rounded-pill px-3`;
            btn.dataset.category = category;
            btn.textContent = category === 'all' ? 'ทั้งหมด' : category;

            btn.onclick = function () {
                // Update active state
                document.querySelectorAll('#category-filters button').forEach(b => {
                    b.className = 'btn btn-sm btn-outline-secondary rounded-pill px-3';
                });
                this.className = 'btn btn-sm btn-primary rounded-pill px-3';

                // Re-render grid
                renderProductGrid();
            };

            container.appendChild(btn);
        });
    }

    // Cart Functions
    function addToCart(product) {
        // Check stock
        const currentInCart = cart.find(item => item.id === product.id)?.quantity || 0;
        if (currentInCart >= parseInt(product.stock)) {
            Swal.fire({
                icon: 'warning',
                title: 'สินค้าหมด',
                text: 'จำนวนสินค้าในสต็อกไม่เพียงพอ'
            });
            return;
        }

        const existingItem = cart.find(item => item.id === product.id);

        if (existingItem) {
            existingItem.quantity++;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: parseFloat(product.price),
                quantity: 1,
                sku: product.sku
            });
        }

        updateCartUI();
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCartUI();
    }

    function updateQuantity(productId, change) {
        const item = cart.find(item => item.id === productId);
        if (item) {
            const product = products.find(p => p.id === productId);
            const newQty = item.quantity + change;

            if (newQty > 0 && newQty <= parseInt(product.stock)) {
                item.quantity = newQty;
            } else if (newQty > parseInt(product.stock)) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'warning',
                    title: 'จำนวนสินค้าเกินสต็อก',
                    showConfirmButton: false,
                    timer: 1500
                });
            } else if (newQty <= 0) {
                removeFromCart(productId);
            }

            updateCartUI();
        }
    }

    function clearCart() {
        if (cart.length > 0) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ต้องการล้างตะกร้าสินค้าทั้งหมดหรือไม่",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'ลบทั้งหมด',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    cart = [];
                    updateCartUI();
                }
            });
        }
    }

    function updateCartUI() {
        const container = document.getElementById('cart-items');
        if (!container) return;

        container.innerHTML = '';

        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-cart-x fs-1 text-secondary"></i>
                    <p class="mt-3">ยังไม่มีสินค้าในตะกร้า</p>
                </div>
            `;
            document.getElementById('checkout-btn').disabled = true;
        } else {
            cart.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item animate-fade-in';
                itemDiv.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-price">${formatCurrency(item.price)} ต่อชิ้น</div>
                    </div>
                    <div class="cart-item-qty">
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', -1)"><i class="bi bi-dash"></i></button>
                        <input type="text" class="qty-input" value="${item.quantity}" readonly>
                        <button class="qty-btn" onclick="updateQuantity('${item.id}', 1)"><i class="bi bi-plus"></i></button>
                        <button class="btn btn-sm text-danger ms-2" onclick="removeFromCart('${item.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                container.appendChild(itemDiv);
            });
            document.getElementById('checkout-btn').disabled = false;
        }

        // Calculate totals
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const taxRate = parseFloat(settings.tax_rate || 7);
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;

        document.getElementById('cart-subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('cart-tax').textContent = formatCurrency(tax);
        document.getElementById('cart-total').textContent = formatCurrency(total);
    }

    function checkout() {
        if (cart.length === 0) return;

        const paymentMethod = document.getElementById('payment-method').value;
        const notes = document.getElementById('order-notes').value;
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const taxRate = parseFloat(settings.tax_rate || 7);
        const tax = subtotal * (taxRate / 100);
        const total = subtotal + tax;

        Swal.fire({
            title: 'ยืนยันการชำระเงิน',
            html: `
                <div class="text-start">
                    <p><strong>ยอดชำระ:</strong> ${formatCurrency(total)}</p>
                    <p><strong>วิธีชำระ:</strong> ${document.getElementById('payment-method').options[document.getElementById('payment-method').selectedIndex].text}</p>
                    <p><strong>จำนวนสินค้า:</strong> ${cart.reduce((sum, item) => sum + item.quantity, 0)} ชิ้น</p>
                </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ยืนยัน',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#10b981'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading
                Swal.fire({
                    title: 'กำลังบันทึก...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                // Prepare data
                const orderData = {
                    items: JSON.stringify(cart.map(item => ({
                        productId: item.id,
                        name: item.name,
                        price: item.price,
                        quantity: item.quantity
                    }))),
                    payment_method: paymentMethod,
                    notes: notes,
                    status: 'completed'
                };

                // Send to backend
                let url = `${SCRIPT_URL}?action=createOrder`;
                Object.keys(orderData).forEach(key => {
                    url += `&${encodeURIComponent(key)}=${encodeURIComponent(orderData[key])}`;
                });

                jsonpRequest(url, response => {
                    if (response.result === 'success') {
                        cart = [];
                        document.getElementById('order-notes').value = '';
                        updateCartUI();

                        Swal.fire({
                            icon: 'success',
                            title: 'ชำระเงินสำเร็จ!',
                            text: `หมายเลขคำสั่งซื้อ: ${response.orderId}`,
                            showCancelButton: true,
                            confirmButtonText: 'ตกลง',
                            cancelButtonText: 'ปิด'
                        });

                        // Refresh data
                        fetchProducts(); // Stock changed
                        fetchOrders();   // New order
                        fetchInventoryLog();
                        fetchDashboardStats();
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: response.message
                        });
                    }
                });
            }
        });
    }

    // Orders Functions
    function renderRecentOrdersTable() {
        const tbody = document.getElementById('recent-orders-table');
        if (!tbody) return;

        tbody.innerHTML = '';

        // Show only last 10 orders
        const recentOrders = orders.slice(0, 10);

        if (recentOrders.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">ไม่มีประวัติคำสั่งซื้อ</td></tr>';
            return;
        }

        recentOrders.forEach(order => {
            // Count total items
            let itemCount = 0;
            let itemNames = '';
            try {
                const items = JSON.parse(order.items);
                itemCount = items.reduce((sum, item) => sum + parseInt(item.quantity), 0);
                itemNames = items.map(item => item.name).join(', ');
                if (itemNames.length > 30) itemNames = itemNames.substring(0, 30) + '...';
            } catch (e) {
                console.error('Error parsing order items', e);
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-numbers text-primary">${order.id}</span></td>
                <td>${new Date(order.created_at).toLocaleDateString('th-TH')}</td>
                <td>${itemNames}</td>
                <td>${itemCount} ชิ้น</td>
                <td class="text-numbers">${formatCurrency(order.total)}</td>
                <td><span class="status-badge status-success">สำเร็จ</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary" onclick="printReceipt('${order.id}')">
                        <i class="bi bi-printer"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function refreshOrders() {
        const btn = document.querySelector('button[onclick="refreshOrders()"] i');
        if (btn) btn.classList.add('spin');

        fetchOrders();

        setTimeout(() => {
            if (btn) btn.classList.remove('spin');
        }, 1000);
    }

    function refreshProducts() {
        const btn = document.querySelector('button[onclick="refreshProducts()"] i');
        if (btn) btn.classList.add('spin');

        fetchProducts();

        setTimeout(() => {
            if (btn) btn.classList.remove('spin');
        }, 1000);
    }

    function printReceipt(orderId) {
        // In a real scenario, this would generate a printable receipt
        // For now, let's just show an alert
        Swal.fire({
            icon: 'info',
            title: 'พิมพ์ใบเสร็จ',
            text: `กำลังพิมพ์ใบเสร็จสำหรับคำสั่งซื้อ #${orderId}`,
            timer: 1500,
            showConfirmButton: false
        });
    }

    // Admin Functions
    function showAdminLogin() {
        Swal.fire({
            title: 'เข้าสู่ระบบเจ้าหน้าที่',
            input: 'password',
            inputLabel: 'รหัสผ่าน',
            inputPlaceholder: 'กรอกรหัสผ่าน...',
            showCancelButton: true,
            confirmButtonText: 'เข้าสู่ระบบ',
            cancelButtonText: 'ยกเลิก',
            preConfirm: (password) => {
                if (password === 'admin1234') { // Simple password for demo
                    return true;
                } else {
                    Swal.showValidationMessage('รหัสผ่านไม่ถูกต้อง');
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('admin-view').style.display = 'block';
                document.getElementById('pos-system').style.display = 'none';
                document.getElementById('admin-login-btn').style.display = 'none';
                document.getElementById('logout-btn').style.display = 'inline-flex';

                // Load admin data
                initCharts();
                if (document.getElementById('admin-total-products').textContent === '0') {
                    fetchDashboardStats();
                    fetchInventoryLog();
                }

                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบแล้ว',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }

    function handleLogout() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('pos-system').style.display = 'block';
        document.getElementById('admin-login-btn').style.display = 'inline-flex';
        document.getElementById('logout-btn').style.display = 'none';
    }

    // Admin: Product Management
    function renderAdminProductsTable() {
        const tbody = document.getElementById('admin-products-table');
        if (!tbody) return;

        tbody.innerHTML = '';

        products.forEach(product => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="text-secondary">${product.id}</span></td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <img src="${getOptimizedProductImage(product)}" class="rounded" width="32" height="32" style="object-fit:cover;">
                        <span>${product.name}</span>
                    </div>
                </td>
                <td><span class="text-xs text-secondary">${product.sku}</span></td>
                <td>${formatCurrency(product.price)}</td>
                <td>
                    <span class="${parseInt(product.stock) <= 5 ? 'text-danger fw-bold' : ''}">
                        ${product.stock} ${product.unit}
                    </span>
                </td>
                <td><span class="badge bg-secondary text-light">${product.category}</span></td>
                <td>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-primary p-1" onclick="editProduct('${product.id}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteProduct('${product.id}')"><i class="bi bi-trash"></i></button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderLowStockItems() {
        const container = document.getElementById('low-stock-grid');
        const countBadge = document.getElementById('admin-low-stock-count');

        if (!container) return;

        container.innerHTML = '';

        const lowStockThreshold = parseInt(settings.low_stock_threshold || 10);
        const lowStockItems = products.filter(p => parseInt(p.stock) <= lowStockThreshold);

        countBadge.textContent = lowStockItems.length;

        if (lowStockItems.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-secondary py-2">ไม่มีสินค้าใกล้หมดสต็อก</div>';
            return;
        }

        lowStockItems.forEach(item => {
            const div = document.createElement('div');
            div.className = 'col-md-6 col-lg-4';
            div.innerHTML = `
                <div class="d-flex align-items-center justify-content-between p-2 rounded border bg-surface">
                    <div class="d-flex align-items-center gap-2">
                        <i class="bi bi-exclamation-circle text-danger"></i>
                        <span class="text-sm fw-medium">${item.name}</span>
                    </div>
                    <span class="badge bg-danger">เหลือ ${item.stock}</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    // Admin: Orders Management 
    function renderAdminOrdersTable() {
        const tbody = document.getElementById('admin-orders-table');
        if (!tbody) return;

        tbody.innerHTML = '';
        const search = document.getElementById('admin-order-search')?.value.toLowerCase() || '';

        const filteredOrders = orders.filter(o =>
            o.id.toLowerCase().includes(search) ||
            (o.items && o.items.toLowerCase().includes(search))
        ).slice(0, 20); // Limit to 20 for performance

        filteredOrders.forEach((order, index) => {
            // Count total items
            let itemCount = 0;
            let itemNames = '';
            try {
                const items = JSON.parse(order.items);
                itemCount = items.reduce((sum, item) => sum + parseInt(item.quantity), 0);
                itemNames = items.slice(0, 2).map(item => item.name).join(', ') + (items.length > 2 ? '...' : '');
            } catch (e) {
                console.error('Error parsing order items', e);
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${new Date(order.created_at).toLocaleDateString('th-TH')}</td>
                <td>ทั่วไป</td>
                <td><span class="text-truncate d-inline-block" style="max-width: 150px;">${itemNames}</span></td>
                <td>${itemCount}</td>
                <td>${formatCurrency(order.total)}</td>
                <td>${order.payment_method}</td>
                <td><span class="status-badge status-success">สำเร็จ</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-eye"></i></button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // Admin: Inventory Log
    function renderInventoryLogTable(logs) {
        if (!logs || !Array.isArray(logs)) return;

        const tbody = document.getElementById('inventory-log-table');
        if (!tbody) return;

        tbody.innerHTML = '';

        // Sort by timestamp desc and take last 20
        const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 20);

        sortedLogs.forEach(log => {
            const tr = document.createElement('tr');

            const isPositive = parseInt(log.quantity_change) > 0;
            const changeClass = isPositive ? 'text-success' : 'text-danger';
            const changeSign = isPositive ? '+' : '';

            tr.innerHTML = `
                <td>${new Date(log.timestamp).toLocaleString('th-TH')}</td>
                <td><span class="badge bg-secondary">${log.action}</span></td>
                <td>${log.product_id}</td>
                <td>${log.product_name}</td>
                <td class="${changeClass} fw-bold">${changeSign}${log.quantity_change}</td>
                <td>${log.new_stock}</td>
                <td class="text-xs text-secondary">${log.reference}</td>
             `;
            tbody.appendChild(tr);
        });
    }

    // Charts
    function initCharts() {
        if (typeof Chart === 'undefined') return;

        // Destroy existing charts
        if (salesChart) salesChart.destroy();
        if (productsChart) productsChart.destroy();

        // Sales Chart
        const ctxSales = document.getElementById('salesChart')?.getContext('2d');
        if (ctxSales) {
            // Process data for last 7 days
            const labels = [];
            const data = [];

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const displayDate = d.toLocaleDateString('th-TH', { weekday: 'short' });

                labels.push(displayDate);

                // Sum sales for this date
                const sales = orders
                    .filter(o => new Date(o.created_at).toISOString().split('T')[0] === dateStr)
                    .reduce((sum, o) => sum + parseFloat(o.total || 0), 0);

                data.push(sales);
            }

            salesChart = new Chart(ctxSales, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ยอดขาย (บาท)',
                        data: data,
                        borderColor: '#22d3ee',
                        backgroundColor: 'rgba(34, 211, 238, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Products Chart (Top 5)
        const ctxProducts = document.getElementById('productsChart')?.getContext('2d');
        if (ctxProducts) {
            // Calculate top products
            const productSales = {};
            orders.forEach(order => {
                try {
                    const items = JSON.parse(order.items);
                    items.forEach(item => {
                        if (!productSales[item.name]) productSales[item.name] = 0;
                        productSales[item.name] += parseInt(item.quantity);
                    });
                } catch (e) { }
            });

            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            productsChart = new Chart(ctxProducts, {
                type: 'doughnut',
                data: {
                    labels: sortedProducts.map(p => p[0]),
                    datasets: [{
                        data: sortedProducts.map(p => p[1]),
                        backgroundColor: [
                            '#22d3ee', '#34d399', '#f472b6', '#fbbf24', '#a78bfa'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#94a3b8' } }
                    }
                }
            });
        }

        updateChartColors();
    }

    function updateChartColors() {
        // Logic to update chart colors based on theme would go here
        // For now, we use default colors which look good on dark mode
    }

    // Modal helpers (Placeholders)
    function showAddProductModal() {
        Swal.fire({
            title: 'เพิ่มสินค้าใหม่',
            html: `
                <input id="new-prod-name" class="swal2-input" placeholder="ชื่อสินค้า">
                <input id="new-prod-sku" class="swal2-input" placeholder="SKU/Barcode">
                <input id="new-prod-price" type="number" class="swal2-input" placeholder="ราคา">
                <input id="new-prod-stock" type="number" class="swal2-input" placeholder="จำนวนสต็อก">
            `,
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            preConfirm: () => {
                return {
                    name: document.getElementById('new-prod-name').value,
                    sku: document.getElementById('new-prod-sku').value,
                    price: document.getElementById('new-prod-price').value,
                    stock: document.getElementById('new-prod-stock').value
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // In real app, send to backend
                Swal.fire('บันทึกแล้ว', 'ข้อมูลสินค้าถูกบันทึกเรียบร้อย', 'success');
            }
        });
    }

    function searchOrders() {
        renderAdminOrdersTable();
    }

    function saveSettings() {
        // Collect settings
        const newSettings = {
            store_name: document.getElementById('store-name').value,
            tax_rate: document.getElementById('tax-rate').value,
            currency: document.getElementById('currency').value,
            low_stock_threshold: document.getElementById('low-stock-threshold').value,
            receipt_header: document.getElementById('receipt-header').value,
            receipt_footer: document.getElementById('receipt-footer').value
        };

        // In real app, send to backend
        settings = { ...settings, ...newSettings };

        Swal.fire({
            icon: 'success',
            title: 'บันทึกสำเร็จ',
            text: 'การตั้งค่าถูกบันทึกเรียบร้อยแล้ว',
            timer: 1500
        });
    }

    // Export helpers
    function exportProducts() {
        Swal.fire('ส่งออกข้อมูล', 'กำลังดาวน์โหลดไฟล์ Excel...', 'info');
    }

    function exportInventory() {
        Swal.fire('ส่งออกข้อมูล', 'กำลังดาวน์โหลดไฟล์ Excel...', 'info');
    }

</script>